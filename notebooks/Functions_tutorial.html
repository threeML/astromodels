

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Functions tutorial &mdash; Astromodels latest documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />
      <link rel="stylesheet" type="text/css" href="../_static/dark_mode_css/general.css?v=c0a7eb24" />
      <link rel="stylesheet" type="text/css" href="../_static/dark_mode_css/dark.css?v=70edf1c7" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=c6e86fd7"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script src="../_static/dark_mode_js/default_dark.js?v=fd565c74"></script>
      <script src="../_static/dark_mode_js/theme_switcher.js?v=358d3910"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Point sources" href="Point_source_tutorial.html" />
    <link rel="prev" title="Powerlaw Prior" href="Powerlaw_Prior.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Astromodels
              <img src="../_static/transp_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Quick_start.html">Quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="Configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="function_list.html">Available Functions</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Functions tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Creating-functions">Creating functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Getting-information-about-an-instance">Getting information about an instance</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Modifying-parameters">Modifying parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Using-physical-units">Using physical units</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Composing-functions">Composing functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Creating-custom-functions">Creating custom functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#The-docstring">The docstring</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Set-units">Set units</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Evaluate">Evaluate</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Custom-functions-in-other-langauges">Custom functions in other langauges</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Advanced-functions">Advanced functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Linking-functions">Linking functions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Point_source_tutorial.html">Point sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="Extended_sources_tutorial.html">Extended source tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="Multi_component_sources.html">Multi-component sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="Model_tutorial.html">Model tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="Priors_for_Bayesian_analysis.html">Priors for Bayesian analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="Additional_features_for_scripts_and_applications.html">Additional features for scripts and applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/API.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/API.html#astromodels">astromodels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/API.html#astromodels-package">astromodels package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Astromodels</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Functions tutorial</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Functions-tutorial">
<h1>Functions tutorial<a class="headerlink" href="#Functions-tutorial" title="Link to this heading"></a></h1>
<p>In astromodels functions can be used as spectral shapes for sources, or to describe time-dependence, phase-dependence, or links among parameters.</p>
<p>To get the list of available functions just do:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astromodels</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">list_functions</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div><table id="table4381217360">
<thead><tr><th>name</th><th>Description</th></tr></thead>
<tr><td>Asymm_Gaussian_on_sphere</td><td>A bidimensional Gaussian function on a sphere (in spherical coordinates) see https://en.wikipedia.org/wiki/Gaussian_function#Two-dimensional_Gaussian_function</td></tr>
<tr><td>Band</td><td>Band model from Band et al., 1993, parametrized with the peak energy</td></tr>
<tr><td>Band_Calderone</td><td>The Band model from Band et al. 1993, implemented however in a way which reduces the covariances between the parameters (Calderone et al., MNRAS, 448, 403C, 2015)</td></tr>
<tr><td>Band_grbm</td><td>Band model from Band et al., 1993, parametrized with the cutoff energy</td></tr>
<tr><td>Beta</td><td>A beta distribution function</td></tr>
<tr><td>Blackbody</td><td>A blackbody function</td></tr>
<tr><td>Broken_powerlaw</td><td>A broken power law function</td></tr>
<tr><td>Cauchy</td><td>The Cauchy distribution</td></tr>
<tr><td>Constant</td><td>Return k</td></tr>
<tr><td>Continuous_injection_diffusion</td><td>Positron and electrons diffusing away from the accelerator</td></tr>
<tr><td>...</td><td>...</td></tr>
<tr><td>SpatialTemplate_2D</td><td>User input Spatial Template.  Expected to be normalized to 1/sr</td></tr>
<tr><td>StepFunction</td><td>A function which is constant on the interval lower_bound - upper_bound and 0 outside the interval. The extremes of the interval are counted as part of the interval.</td></tr>
<tr><td>StepFunctionUpper</td><td>A function which is constant on the interval lower_bound - upper_bound and 0 outside the interval. The upper interval is open.</td></tr>
<tr><td>Super_cutoff_powerlaw</td><td>A power law with a super-exponential cutoff</td></tr>
<tr><td>TbAbs</td><td>Photometric absorption (Tbabs implementation), f(E) = exp(- NH * sigma(E)) contributed by Dominique Eckert</td></tr>
<tr><td>TemplateModel</td><td>A template model</td></tr>
<tr><td>Truncated_gaussian</td><td>A  truncated Gaussian function defined on the interval between the lower_bound (a) and upper_bound (b)</td></tr>
<tr><td>Uniform_prior</td><td>A function which is constant on the interval lower_bound - upper_bound and 0 outside the interval. The extremes of the interval are counted as part of the interval.</td></tr>
<tr><td>WAbs</td><td>Photometric absorption (Wabs implementation), f(E) = exp(- NH * sigma(E)) contributed by Dominique Eckert</td></tr>
<tr><td>ZDust</td><td>Extinction by dust grains from Pei (1992), suitable for IR, optical and UV energy bands, including the full energy ranges of the Swift UVOT and XMM-Newton OM detectors. Three models are included which characterize the extinction curves of (1) the Milky Way, (2) the LMC and (3) the SMC. The models can be modified by redshift and can therefore be applied to extragalactic sources. The transmission is set to unity shortward of 912 Angstroms in the rest frame of the dust. This is incorrect physically but does allow the model to be used in combination with an X-ray photoelectric absorption model such as phabs. Parameter 1 (method) describes which extinction curve (MW, LMC or SMC) will be constructed and should never be allowed to float during a fit. The extinction at V, A(V) = E(B-V) x Rv. Rv should typically remain frozen for a fit. Standard values for Rv are MW = 3.08, LMC = 3.16 and SMC = 2.93 (from table 2 of Pei 1992), although these may not be applicable to more distant dusty sources.</td></tr>
<tr><td>_ComplexTestFunction</td><td>A useless function to be used during automatic tests</td></tr>
</table></div></div>
</div>
<p>If you need more info about a function, you can obtain it by using:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Gaussian</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<ul>

<li>description: A Gaussian function</li>

<li>formula: $ K \frac{1}{\sigma \sqrt{2 \pi}}\exp{\frac{(x-\mu)^2}{2~(\sigma)^2}} $</li>

<li>default parameters:
<ul>

<li>F:
<ul>

<li>value: 1.0</li>

<li>desc: Integral between -inf and +inf. Fix this to 1 to obtain a Normal distribution</li>

<li>min_value: None</li>

<li>max_value: None</li>

<li>unit: </li>

<li>is_normalization: False</li>

<li>delta: 0.1</li>

<li>free: True</li>

</ul>

</li>

<li>mu:
<ul>

<li>value: 0.0</li>

<li>desc: Central value</li>

<li>min_value: None</li>

<li>max_value: None</li>

<li>unit: </li>

<li>is_normalization: False</li>

<li>delta: 0.1</li>

<li>free: True</li>

</ul>

</li>

<li>sigma:
<ul>

<li>value: 1.0</li>

<li>desc: standard deviation</li>

<li>min_value: 1e-12</li>

<li>max_value: None</li>

<li>unit: </li>

<li>is_normalization: False</li>

<li>delta: 0.1</li>

<li>free: True</li>

</ul>

</li>

</ul>

</li>

</ul></div>
</div>
<p>Note that you don’t need to create an instance in order to call the info() method.</p>
<section id="Creating-functions">
<h2>Creating functions<a class="headerlink" href="#Creating-functions" title="Link to this heading"></a></h2>
<p>Functions can be created in two different ways. We can create an instance with the default values for the parameters like this:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">powerlaw_instance</span> <span class="o">=</span> <span class="n">Powerlaw</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>or we can specify on construction specific values for the parameters:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">powerlaw_instance</span> <span class="o">=</span> <span class="n">Powerlaw</span><span class="p">(</span><span class="n">K</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">index</span><span class="o">=-</span><span class="mf">2.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>If you don’t remember the names of the parameters just call the .info() method as in powerlaw.info() as demonstrated above.</p>
</section>
<section id="Getting-information-about-an-instance">
<h2>Getting information about an instance<a class="headerlink" href="#Getting-information-about-an-instance" title="Link to this heading"></a></h2>
<p>Using the <code class="docutils literal notranslate"><span class="pre">.display()</span></code> method we get a representation of the instance which exploits the features of the environment we are using. If we are running inside a IPython notebook, a rich representation with the formula of the function will be displayed (if available). Otherwise, in a normal terminal, the latex formula will not be rendered:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">powerlaw_instance</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<ul>

<li>description: A simple power-law</li>

<li>formula: $ K~\frac{x}{piv}^{index} $</li>

<li>parameters:
<ul>

<li>K:
<ul>

<li>value: 0.01</li>

<li>desc: Normalization (differential flux at the pivot value)</li>

<li>min_value: 1e-30</li>

<li>max_value: 1000.0</li>

<li>unit: </li>

<li>is_normalization: True</li>

<li>delta: 0.1</li>

<li>free: True</li>

</ul>

</li>

<li>piv:
<ul>

<li>value: 1.0</li>

<li>desc: Pivot value</li>

<li>min_value: None</li>

<li>max_value: None</li>

<li>unit: </li>

<li>is_normalization: False</li>

<li>delta: 0.1</li>

<li>free: False</li>

</ul>

</li>

<li>index:
<ul>

<li>value: -2.2</li>

<li>desc: Photon index</li>

<li>min_value: -10.0</li>

<li>max_value: 10.0</li>

<li>unit: </li>

<li>is_normalization: False</li>

<li>delta: 0.20099999999999998</li>

<li>free: True</li>

</ul>

</li>

</ul>

</li>

</ul></div>
</div>
<p>It is also possible to get the text-only representation by simply printing the object like this:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">powerlaw_instance</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  * description: A simple power-law
  * formula: $ K~\frac{x}{piv}^{index} $
  * parameters:
    * K:
      * value: 0.01
      * desc: Normalization (differential flux at the pivot value)
      * min_value: 1.0e-30
      * max_value: 1000.0
      * unit: &#39;&#39;
      * is_normalization: true
      * delta: 0.1
      * free: true
    * piv:
      * value: 1.0
      * desc: Pivot value
      * min_value: null
      * max_value: null
      * unit: &#39;&#39;
      * is_normalization: false
      * delta: 0.1
      * free: false
    * index:
      * value: -2.2
      * desc: Photon index
      * min_value: -10.0
      * max_value: 10.0
      * unit: &#39;&#39;
      * is_normalization: false
      * delta: 0.20099999999999998
      * free: true

</pre></div></div>
</div>
<div class="admonition note">
<p><strong>Note:</strong> the <code class="docutils literal notranslate"><span class="pre">.display()</span></code> method of an instance displays the current values of the parameters, while the .info() method demonstrated above (for which you don’t need an instance) displays the default values of the parameters.</p>
</div>
</section>
<section id="Modifying-parameters">
<h2>Modifying parameters<a class="headerlink" href="#Modifying-parameters" title="Link to this heading"></a></h2>
<p>Modifying a parameter of a function is easy:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Modify current value</span>

<span class="n">powerlaw_instance</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="mf">1.2</span>

<span class="c1"># Modify minimum</span>
<span class="n">powerlaw_instance</span><span class="o">.</span><span class="n">K</span><span class="o">.</span><span class="n">min_value</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="c1"># Modify maximum</span>
<span class="n">powerlaw_instance</span><span class="o">.</span><span class="n">K</span><span class="o">.</span><span class="n">max_value</span> <span class="o">=</span> <span class="mi">15</span>

<span class="c1"># We can also modify minimum and maximum at the same time</span>
<span class="n">powerlaw_instance</span><span class="o">.</span><span class="n">K</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>

<span class="c1"># Modifying the delta for the parameter</span>
<span class="c1"># (which can be used by downstream software for fitting, for example)</span>
<span class="n">powerlaw_instance</span><span class="o">.</span><span class="n">K</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="mf">0.25</span>

<span class="c1"># Fix the parameter</span>
<span class="n">powerlaw_instance</span><span class="o">.</span><span class="n">K</span><span class="o">.</span><span class="n">fix</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># or equivalently</span>
<span class="n">powerlaw_instance</span><span class="o">.</span><span class="n">K</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Free it again</span>
<span class="n">powerlaw_instance</span><span class="o">.</span><span class="n">K</span><span class="o">.</span><span class="n">fix</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># or equivalently</span>
<span class="n">powerlaw_instance</span><span class="o">.</span><span class="n">K</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># We can verify what we just did by printing again the whole function as shown above,</span>
<span class="c1"># or simply printing the parameter:</span>
<span class="n">powerlaw_instance</span><span class="o">.</span><span class="n">K</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> We have set the min_value of Powerlaw.K to </span><span style="color: #c0c0c0; text-decoration-color: #c0c0c0; font-weight: bold">1e-99</span><span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> because there was a postive    </span><a href="file:///Users/runner/work/astromodels/astromodels/astromodels/core/parameter.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">parameter.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/runner/work/astromodels/astromodels/astromodels/core/parameter.py#715" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">715</span></a>
<span style="color: #00ff00; text-decoration-color: #00ff00">         </span>         <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">transform                                                                        </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                </span>
</pre></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
Parameter K = 1.2 []
(min_value = 0.5, max_value = 15.0, delta = 0.25, free = True)</div>
</div>
</section>
<section id="Using-physical-units">
<h2>Using physical units<a class="headerlink" href="#Using-physical-units" title="Link to this heading"></a></h2>
<p>Astromodels uses the facility defined in astropy.units to make easier to convert between units during interactive analysis, when assigning to parameters. In order for functions to be aware of their units, they must be part of a `<code class="docutils literal notranslate"><span class="pre">Source</span></code>. Let’s create one:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">powerlaw_instance</span> <span class="o">=</span> <span class="n">Powerlaw</span><span class="p">()</span>

<span class="n">point_source</span> <span class="o">=</span> <span class="n">PointSource</span><span class="p">(</span><span class="s2">&quot;my_point_source&quot;</span><span class="p">,</span><span class="n">ra</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">dec</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">spectral_shape</span><span class="o">=</span><span class="n">powerlaw_instance</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now we can see the units</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">powerlaw_instance</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<ul>

<li>description: A simple power-law</li>

<li>formula: $ K~\frac{x}{piv}^{index} $</li>

<li>parameters:
<ul>

<li>K:
<ul>

<li>value: 1.0</li>

<li>desc: Normalization (differential flux at the pivot value)</li>

<li>min_value: 1e-30</li>

<li>max_value: 1000.0</li>

<li>unit: keV-1 s-1 cm-2</li>

<li>is_normalization: True</li>

<li>delta: 0.1</li>

<li>free: True</li>

</ul>

</li>

<li>piv:
<ul>

<li>value: 1.0</li>

<li>desc: Pivot value</li>

<li>min_value: None</li>

<li>max_value: None</li>

<li>unit: keV</li>

<li>is_normalization: False</li>

<li>delta: 0.1</li>

<li>free: False</li>

</ul>

</li>

<li>index:
<ul>

<li>value: -2.01</li>

<li>desc: Photon index</li>

<li>min_value: -10.0</li>

<li>max_value: 10.0</li>

<li>unit: </li>

<li>is_normalization: False</li>

<li>delta: 0.20099999999999998</li>

<li>free: True</li>

</ul>

</li>

</ul>

</li>

</ul></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">powerlaw_instance</span><span class="o">.</span><span class="n">x_unit</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$\mathrm{keV}$</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">powerlaw_instance</span><span class="o">.</span><span class="n">y_unit</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$\mathrm{\frac{1}{keV\,s\,cm^{2}}}$</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">u</span>

<span class="c1"># Express the differential flux at the pivot energy in 1 / (MeV cm2 s)</span>

<span class="n">powerlaw_instance</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="p">(</span><span class="mf">122.3</span> <span class="o">/</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">MeV</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">cm</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">cm</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">powerlaw_instance</span><span class="o">.</span><span class="n">K</span><span class="p">)</span>

<span class="c1"># Express the differential flux at the pivot energy in 1 / (GeV m2 s)</span>
<span class="n">powerlaw_instance</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="p">(</span><span class="mf">122.3</span> <span class="o">/</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">))</span>


<span class="nb">print</span><span class="p">(</span><span class="n">powerlaw_instance</span><span class="o">.</span><span class="n">K</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Parameter K = 0.1223 [1 / (keV s cm2)]
(min_value = 1e-30, max_value = 1000.0, delta = 0.1, free = True)
Parameter K = 1.2230000000000013e-08 [1 / (keV s cm2)]
(min_value = 1e-30, max_value = 1000.0, delta = 0.1, free = True)
</pre></div></div>
</div>
<p>We see that astromodels does the unit conversion for us in the background!</p>
<p>However, astropy units are <strong>very slow</strong> and we would not want to deal with them or set parameters with units during a fit. Thus, if you do not specify units when setting a parameter, the value is assumed to have the units specified in the construction of the function.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> powerlaw_instance.K = 1
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
7.59 µs ± 292 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> powerlaw_instance.K = (122.3 / (u.MeV * u.cm * u.cm * u.s))
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
113 µs ± 9.37 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
</pre></div></div>
</div>
<p>As you can see using <strong>astropy.units requires about 10x more than using a plain assignment</strong>. In an interactive analysis you are unlikely to notice the difference, but if you use units in a loop or during a fit this slow-down will add up an become very noticeable. <strong>Note that this is a feature of astropy.units, not of astromodels.</strong></p>
</section>
<section id="Composing-functions">
<h2>Composing functions<a class="headerlink" href="#Composing-functions" title="Link to this heading"></a></h2>
<p>We can create arbitrary complex functions by combining “primitive” functions using the normal math operators:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">composite</span> <span class="o">=</span> <span class="n">Gaussian</span><span class="p">()</span> <span class="o">+</span> <span class="n">Powerlaw</span><span class="p">()</span>

<span class="c1"># Instead of the usual .display(), which would print all the many parameters,</span>
<span class="c1"># let&#39;s print just the description of the new composite functions:</span>
<span class="nb">print</span><span class="p">(</span><span class="n">composite</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(Gaussian{1} + Powerlaw{2})
</pre></div></div>
</div>
<p>These expressions can be as complex as needed. For example:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crazy_function</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">Sin</span><span class="p">()</span> <span class="o">+</span> <span class="n">Powerlaw</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="n">Gaussian</span><span class="p">())</span> <span class="o">/</span> <span class="mf">3.0</span>

<span class="nb">print</span><span class="p">(</span><span class="n">crazy_function</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
((Sin{1} * 3) + (((Powerlaw{2} ** 2) * (Gaussian{3} + 5)) / 3.0))
</pre></div></div>
</div>
<p>The numbers between <code class="docutils literal notranslate"><span class="pre">{}</span></code> enumerate the unique functions which constitute a composite function. This is useful because composite functions can be created starting from pre-existing instances of functions, in which case the same instance can be used more than once. For example:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_powerlaw</span> <span class="o">=</span> <span class="n">Powerlaw</span><span class="p">()</span>
<span class="n">a_sin</span> <span class="o">=</span> <span class="n">Sin</span><span class="p">()</span>

<span class="n">another_composite</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">a_powerlaw</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">a_powerlaw</span><span class="p">)</span> <span class="o">*</span> <span class="n">a_sin</span>

<span class="nb">print</span><span class="p">(</span><span class="n">another_composite</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
((Powerlaw{1} * 2) + ((Powerlaw{1} + 3) * Sin{2}))
</pre></div></div>
</div>
<p>In this case the same instance of a power law has been used twice. Changing the value of the parameters for “a_powerlaw” will affect also the second part of the expression. Instead, by doing this:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">another_composite2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Powerlaw</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">Powerlaw</span><span class="p">())</span> <span class="o">*</span> <span class="n">Sin</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">another_composite2</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
((Powerlaw{1} * 2) + ((Powerlaw{2} + 3) * Sin{3}))
</pre></div></div>
</div>
<p>we will end up with two independent sets of parameters for the two power laws. The difference can be seen immediately from the number of parameters of the two composite functions:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">another_composite</span><span class="o">.</span><span class="n">parameters</span><span class="p">))</span> <span class="c1"># 6 parameters</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">another_composite2</span><span class="o">.</span><span class="n">parameters</span><span class="p">))</span> <span class="c1"># 9 parameters</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
6
9
</pre></div></div>
</div>
</section>
<section id="Creating-custom-functions">
<h2>Creating custom functions<a class="headerlink" href="#Creating-custom-functions" title="Link to this heading"></a></h2>
<p>One of the most powerful aspects of astromodels is the ability to quickly build custom functions on the fly. The source code for a function can be pure python, FORTRAN linked via f2py, C++ linked via cython, etc. Anything that provides a python function can be used to fit data.</p>
<p>To build a custom spectral 1D function in astromodels, we need to import a few things that will allow astromodels to recognize your model.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">astromodels.functions.function</span><span class="w"> </span><span class="kn">import</span> <span class="n">Function1D</span><span class="p">,</span> <span class="n">FunctionMeta</span><span class="p">,</span> <span class="n">ModelAssertionViolation</span>
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Function1D</span></code> is the base class for 1D spectral models and <code class="docutils literal notranslate"><span class="pre">FunctionMeta</span></code> is a python meta type class that ensures all the needed parts of a model are in the class as well as making the class function as it should.</p>
<p>There are three basic parts to declaring a model:</p>
<ul class="simple">
<li><p>the docstring</p></li>
<li><p>the units setter</p></li>
<li><p>the evaluate function</p></li>
</ul>
<p>Let’s look at the simple case of the power law already define in astromodels.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Powerlaw</span><span class="p">(</span><span class="n">Function1D</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">FunctionMeta</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        description :</span>
<span class="sd">            A  power-law</span>
<span class="sd">        latex : $ K~\frac{x}{piv}^{index} $</span>
<span class="sd">        parameters :</span>
<span class="sd">            K :</span>
<span class="sd">                desc : Normalization (differential flux at the pivot value)</span>
<span class="sd">                initial value : 1.0</span>
<span class="sd">                is_normalization : True</span>
<span class="sd">                transformation : log10</span>
<span class="sd">                min : 1e-30</span>
<span class="sd">                max : 1e3</span>
<span class="sd">                delta : 0.1</span>
<span class="sd">            piv :</span>
<span class="sd">                desc : Pivot value</span>
<span class="sd">                initial value : 1</span>
<span class="sd">                fix : yes</span>
<span class="sd">            index :</span>
<span class="sd">                desc : Photon index</span>
<span class="sd">                initial value : -2</span>
<span class="sd">                min : -10</span>
<span class="sd">                max : 10</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="k">def</span><span class="w"> </span><span class="nf">_set_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_unit</span><span class="p">,</span> <span class="n">y_unit</span><span class="p">):</span>
            <span class="c1"># The index is always dimensionless</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">astropy_units</span><span class="o">.</span><span class="n">dimensionless_unscaled</span>

            <span class="c1"># The pivot energy has always the same dimension as the x variable</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">piv</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">x_unit</span>

            <span class="c1"># The normalization has the same units as the y</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">y_unit</span>


        <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">piv</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>

            <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">piv</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">K</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
<section id="The-docstring">
<h3>The docstring<a class="headerlink" href="#The-docstring" title="Link to this heading"></a></h3>
<p>We have used the docstring interface to provide a YAML description of the function. This sets up the important information used in the fitting process and record keeping. The docstring has three parts:</p>
<ul class="simple">
<li><p>description</p>
<ul>
<li><p>The description is a text string that provides readable info about the model. Nothing fancy, but good descriptions help to inform the user.</p></li>
</ul>
</li>
<li><p>latex</p>
<ul>
<li><p>If the model is analytic, a latex formula can be included</p></li>
</ul>
</li>
<li><p>parameters</p>
<ul>
<li><p>For each parameter, a description and initial value must be included. Transformations for fitting, min/max values and fixing the parameter can also be described here.</p></li>
</ul>
</li>
</ul>
<p>Optionally, there can be an additional <code class="docutils literal notranslate"><span class="pre">properties</span></code> category that we will cover later.</p>
<p>Keep in mind that this is in YAML format.</p>
</section>
<section id="Set-units">
<h3>Set units<a class="headerlink" href="#Set-units" title="Link to this heading"></a></h3>
<p>astromodels keeps track of units for you. However, a model must be set up to properly describe the units with astropy’s unit system. Keep in mind that models are fit with a differential photon flux,</p>
<div class="math notranslate nohighlight">
\[\frac{d N_p}{dA dt dE}\]</div>
<p>so your units should reflect this convention. Therefore, proper normalizations should be taken into account.</p>
</section>
<section id="Evaluate">
<h3>Evaluate<a class="headerlink" href="#Evaluate" title="Link to this heading"></a></h3>
<p>This is where the function is evaluated. The first argument <strong>must be called x</strong> and the parameter names and ordering must reflect what is in the docstring. Any number of operations can take place inside the evaluate call, but remember that the return must be in the form of a differential photon flux. For 2D and 3D functions, the functions have <strong>y</strong> and <strong>z</strong> for their first arguments as well. ** x, y, and z are reserved names in functions**.</p>
<p>A functions is defined in a python session. <strong>If you save the results of a fit to an AnalysisResults file and try to load this file without loading this model, you will get a error</strong> Thus, remember to import any local models you used for an analysis before trying to reload that analysis.</p>
</section>
</section>
<section id="Custom-functions-in-other-langauges">
<h2>Custom functions in other langauges<a class="headerlink" href="#Custom-functions-in-other-langauges" title="Link to this heading"></a></h2>
<p>What if your model is built from a C++ function and you want to fit that directly to the data? using Cython, pybind11, f2py, etc, you can wrap these models and call them easily.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="k">def</span><span class="w"> </span><span class="nf">cpp_function_wrapper</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="c1"># we could wrap a c++ function here</span>
    <span class="c1"># with cython, pybind11, etc</span>

    <span class="k">return</span> <span class="n">a</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cpp_function_wrapper</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2.0
</pre></div></div>
</div>
<p>Now we will define a astromodels function that will handle both the unit and non-unit call.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">astropy_units</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CppModel</span><span class="p">(</span><span class="n">Function1D</span><span class="p">,</span><span class="n">metaclass</span><span class="o">=</span><span class="n">FunctionMeta</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        description :</span>
<span class="sd">            A spectral model wrapping a cython function</span>
<span class="sd">        latex : $$</span>
<span class="sd">        parameters :</span>
<span class="sd">            a :</span>
<span class="sd">                desc : Normalization (differential flux)</span>
<span class="sd">                initial value : 1.0</span>
<span class="sd">                is_normalization : True</span>
<span class="sd">                min : 1e-30</span>
<span class="sd">                max : 1e3</span>
<span class="sd">                delta : 0.1</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_set_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_unit</span><span class="p">,</span> <span class="n">y_unit</span><span class="p">):</span>

            <span class="c1"># The normalization has the same units as the y</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">y_unit</span>


        <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>

            <span class="c1"># check is the function is being called with units</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">astropy_units</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>

                <span class="c1"># get the values</span>
                <span class="n">a_</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>

                <span class="c1"># save the unit</span>
                <span class="n">unit_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_unit</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># we do not need to do anything here</span>
                <span class="n">a_</span> <span class="o">=</span> <span class="n">a</span>

                <span class="c1"># this will basically be ignored</span>
                <span class="n">unit_</span> <span class="o">=</span> <span class="mf">1.</span>

            <span class="c1"># call the cython function</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">cpp_function_wrapper</span><span class="p">(</span><span class="n">a_</span><span class="p">)</span>

            <span class="c1"># add back the unit if needed</span>
            <span class="k">return</span> <span class="n">flux</span> <span class="o">*</span> <span class="n">unit_</span>
</pre></div>
</div>
</div>
<p>We can check the unit and non-unit call by making a point source and evaluating it</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cpp_spectrum</span> <span class="o">=</span> <span class="n">CppModel</span><span class="p">()</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astromodels</span><span class="w"> </span><span class="kn">import</span> <span class="n">PointSource</span>

<span class="n">point_source</span> <span class="o">=</span> <span class="n">PointSource</span><span class="p">(</span><span class="s1">&#39;ps&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">spectral_shape</span><span class="o">=</span><span class="n">cpp_spectrum</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">point_source</span><span class="p">(</span><span class="mf">10.</span><span class="p">))</span>
<span class="n">point_source</span><span class="p">(</span><span class="mf">10.</span> <span class="o">*</span> <span class="n">astropy_units</span><span class="o">.</span><span class="n">keV</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1.0
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$1 \; \mathrm{\frac{1}{keV\,s\,cm^{2}}}$</div></div>
</div>
</section>
<section id="Advanced-functions">
<h2>Advanced functions<a class="headerlink" href="#Advanced-functions" title="Link to this heading"></a></h2>
<p>We are not limited to functions that can only take numerical parameters as arguments. We can also link other astromodels function into a function to expand its abilities. ### Properties</p>
<p>Let’s create a function that uses text based switches to alter its functionality</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SwitchFunction</span><span class="p">(</span><span class="n">Function1D</span><span class="p">,</span><span class="n">metaclass</span><span class="o">=</span><span class="n">FunctionMeta</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        description :</span>
<span class="sd">            A demo function that can alter its state</span>
<span class="sd">        latex : $$</span>

<span class="sd">        parameters :</span>
<span class="sd">            a :</span>
<span class="sd">                desc : Normalization (differential flux)</span>
<span class="sd">                initial value : 1.0</span>
<span class="sd">                is_normalization : True</span>
<span class="sd">                min : 1e-30</span>
<span class="sd">                max : 1e3</span>
<span class="sd">                delta : 0.1</span>
<span class="sd">        properties:</span>
<span class="sd">            switch:</span>
<span class="sd">                desc: a switch for functions</span>
<span class="sd">                initial value: powerlaw</span>
<span class="sd">                allowed values:</span>
<span class="sd">                    - powerlaw</span>
<span class="sd">                    - cosine</span>
<span class="sd">                function: _say_hello</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_say_hello</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># called when we set the value of switch</span>

            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>


        <span class="k">def</span><span class="w"> </span><span class="nf">_set_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_unit</span><span class="p">,</span> <span class="n">y_unit</span><span class="p">):</span>

            <span class="c1"># The normalization has the same units as the y</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">y_unit</span>


        <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;powerlaw&quot;</span><span class="p">:</span>

                <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">powerlaw</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;cosine&quot;</span><span class="p">:</span>

                <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<p>We have added a text parameter called switch and specified the allowed values that it can take on. We can of course allow it to take on any value. Additionally, we have specified a function to call whenever we change the value. This allows use to do things like read in a table from a dictionary or load a file, etc. Properties can be set in the constructor of a function. They behave just like parameters except that they do not participate in the function call. Thus, their state is saved whenever
you serialize the model to disk.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><br/><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">SwitchFunction</span><span class="p">()</span>

<span class="n">f</span><span class="o">.</span><span class="n">switch</span> <span class="o">=</span> <span class="s1">&#39;cosine&#39;</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
powerlaw
cosine
</pre></div></div>
</div>
<p>In the docstring, one can also specify <code class="docutils literal notranslate"><span class="pre">defer:</span> <span class="pre">True</span></code> which allows you to not set a value until instancing an object. This is useful if you have a model that reads in file at runtime, but the file name is not known until then. Check out the source code of astromodels to see how properties can be used to expand the functionality of your custom models. For example, the absorption models such as <code class="docutils literal notranslate"><span class="pre">TbAbs</span></code> take advantage of this to set their abundance tables.</p>
<section id="Linking-functions">
<h3>Linking functions<a class="headerlink" href="#Linking-functions" title="Link to this heading"></a></h3>
<p>What if you need to call another astromodels function from inside your custom function? This is achieved by linking functions. For example, let’s create a convolutional model that redshifts the energies of and model linked to it:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Redshifter</span><span class="p">(</span><span class="n">Function1D</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">FunctionMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    description :</span>
<span class="sd">        a function that can redshift the energies of any 1D function</span>

<span class="sd">    latex: not available</span>

<span class="sd">    parameters :</span>
<span class="sd">        redshift :</span>
<span class="sd">            desc : the redshift</span>
<span class="sd">            initial value : 0</span>
<span class="sd">            min : 0</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_set_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_unit</span><span class="p">,</span> <span class="n">y_unit</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">astropy_units</span><span class="o">.</span><span class="n">dimensionless_unscaled</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">set_linked_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
         <span class="c1"># this is an optional helper to</span>
             <span class="c1"># ease in the setting of the function</span>



        <span class="k">if</span> <span class="s2">&quot;func&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_functions</span><span class="p">:</span>

            <span class="c1"># since we only want to link one function</span>
                    <span class="c1"># we unlink if we have linked before</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">unlink_external_function</span><span class="p">(</span><span class="s2">&quot;func&quot;</span><span class="p">)</span>

        <span class="c1"># this allows use to link in a function</span>
            <span class="c1"># with an internal name &#39;func&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">link_external_function</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="s2">&quot;func&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_linked_function</span> <span class="o">=</span> <span class="n">function</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_linked_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># linked functions are stored in a dictionary</span>
            <span class="c1"># but you</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_functions</span><span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">]</span>


    <span class="n">linked_function</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">get_linked_function</span><span class="p">,</span>
        <span class="n">set_linked_function</span><span class="p">,</span>
        <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Get/set linked function&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">redshift</span><span class="p">):</span>


        <span class="c1"># we can call the function here</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linked_function</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">redshift</span><span class="p">))</span>
<br/></pre></div>
</div>
</div>
<p>With this function, whenever we set the linked_function property to another astromodels function, its call will return that function redshifted.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">Powerlaw</span><span class="p">()</span>
<span class="n">rs</span> <span class="o">=</span> <span class="n">Redshifter</span><span class="p">(</span><span class="n">redshift</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">rs</span><span class="o">.</span><span class="n">linked_function</span> <span class="o">=</span> <span class="n">p</span>

<span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mf">10.</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">rs</span><span class="p">(</span><span class="mf">10.</span><span class="p">))</span>
<br/><br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.009772372209558112
0.0024262173759824015
</pre></div></div>
</div>
<p>We have added a lot of syntax sugar to make it easier for users to handle the function, but every function in astromodels has the members <code class="docutils literal notranslate"><span class="pre">f.link_external_function(func,</span> <span class="pre">'internal_name')</span></code> and <code class="docutils literal notranslate"><span class="pre">f.unlink_external_function('internal_name')</span></code>. You can link as many functions as needed and they are accessed via an internal dictionary <code class="docutils literal notranslate"><span class="pre">self._extranal_functions</span></code>. As long as all functions used are part of the model, all the linking is saved when a model is saved to disk allowing you to restore all
the complexity you built.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Powerlaw_Prior.html" class="btn btn-neutral float-left" title="Powerlaw Prior" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Point_source_tutorial.html" class="btn btn-neutral float-right" title="Point sources" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016--2025, G.Vianello, J. M. Burgess, N. Di Lalla, N. Omodei, H. Fleischhack.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>