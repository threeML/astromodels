

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>astromodels.functions.function &mdash; Astromodels latest documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=ad0ac74c" />
      <link rel="stylesheet" type="text/css" href="../../../_static/dark_mode_css/general.css?v=c0a7eb24" />
      <link rel="stylesheet" type="text/css" href="../../../_static/dark_mode_css/dark.css?v=70edf1c7" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=c6e86fd7"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="../../../_static/dark_mode_js/default_dark.js?v=fd565c74"></script>
      <script src="../../../_static/dark_mode_js/theme_switcher.js?v=358d3910"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Astromodels
              <img src="../../../_static/transp_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/Quick_start.html">Quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/Configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/function_list.html">Available Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/Functions_tutorial.html">Functions tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/Point_source_tutorial.html">Point sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/Extended_sources_tutorial.html">Extended source tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/Multi_component_sources.html">Multi-component sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/Model_tutorial.html">Model tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/Priors_for_Bayesian_analysis.html">Priors for Bayesian analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/Additional_features_for_scripts_and_applications.html">Additional features for scripts and applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/API.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/API.html#astromodels">astromodels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/API.html#astromodels-package">astromodels package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_notes.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Astromodels</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">astromodels.functions.function</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for astromodels.functions.function</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">collections</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">textwrap</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">builtins</span><span class="w"> </span><span class="kn">import</span> <span class="nb">chr</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="nb">str</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">operator</span><span class="w"> </span><span class="kn">import</span> <span class="n">attrgetter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">u</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numba</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nb</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">yaml.reader</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReaderError</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astromodels.core.memoization</span><span class="w"> </span><span class="kn">import</span> <span class="n">memoize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astromodels.core.my_yaml</span><span class="w"> </span><span class="kn">import</span> <span class="n">my_yaml</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astromodels.core.parameter</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parameter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astromodels.core.parameter_transformation</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_transformation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astromodels.core.property</span><span class="w"> </span><span class="kn">import</span> <span class="n">FunctionProperty</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astromodels.core.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astromodels.utils.file_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">copy_if_needed</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astromodels.utils.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_logger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astromodels.utils.pretty_list</span><span class="w"> </span><span class="kn">import</span> <span class="n">dict_to_list</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astromodels.utils.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">dict_to_table</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;giacomov&quot;</span>


<span class="k">try</span><span class="p">:</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">display</span>

<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>

    <span class="n">has_ipython</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">else</span><span class="p">:</span>

    <span class="n">has_ipython</span> <span class="o">=</span> <span class="kc">True</span>


<div class="viewcode-block" id="WarningNoTests">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.WarningNoTests">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WarningNoTests</span><span class="p">(</span><span class="ne">ImportWarning</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="FunctionDefinitionError">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.FunctionDefinitionError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FunctionDefinitionError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="FunctionInstanceError">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.FunctionInstanceError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FunctionInstanceError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="DesignViolation">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.DesignViolation">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DesignViolation</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="ModelAssertionViolation">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.ModelAssertionViolation">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ModelAssertionViolation</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="WrongDimensionality">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.WrongDimensionality">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WrongDimensionality</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="TestSpecificationError">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.TestSpecificationError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestSpecificationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="TestFailed">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.TestFailed">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestFailed</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="DocstringIsNotRaw">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.DocstringIsNotRaw">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DocstringIsNotRaw</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="UnknownFunction">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.UnknownFunction">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">UnknownFunction</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="UnknownParameter">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.UnknownParameter">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">UnknownParameter</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="k">pass</span></div>



<span class="c1"># Value to indicate that no latex formula has been given</span>
<span class="n">NO_LATEX_FORMULA</span> <span class="o">=</span> <span class="s2">&quot;(no latex formula available)&quot;</span>


<span class="c1"># A function to find the calling sequence of a function, compatible</span>
<span class="c1"># with both python2 and 3</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_py2to3_getargspec</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>

        <span class="n">argspec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># PY3</span>

        <span class="n">argspec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">argspec</span>


<span class="c1"># This dictionary will contain the known function by name, so that the model_parser can</span>
<span class="c1"># instance them by looking into this dictionary. It will be filled by the FunctionMeta</span>
<span class="c1"># meta-class.</span>

<span class="n">_known_functions</span> <span class="o">=</span> <span class="p">{}</span>


<span class="c1"># The following is a metaclass for all the functions</span>
<div class="viewcode-block" id="FunctionMeta">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.FunctionMeta">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FunctionMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A metaclass for the models, which takes care of setting up the</span>
<span class="sd">    parameters and the other attributes according to the definition given in</span>
<span class="sd">    the documentation of the function class.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>

        <span class="c1"># We do the parsing of the parameters in the __new__ instead of the __init__ so</span>
        <span class="c1"># this is the first thing that runs when importing astromodels</span>

        <span class="c1"># Enforce the presence of the evaluate method</span>

        <span class="k">if</span> <span class="s2">&quot;evaluate&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dct</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You have to implement the &#39;evaluate&#39; method in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">()</span>

        <span class="c1"># We also need the method _set_units</span>

        <span class="k">if</span> <span class="s2">&quot;_set_units&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dct</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;You have to implement the &#39;_set_units&#39; method in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span>
            <span class="p">)</span>

        <span class="c1"># Now parse the documentation of the function which contains the parameter</span>
        <span class="c1"># specification</span>

        <span class="c1"># The doc is a YAML document containing among other things the definition of</span>
        <span class="c1"># the parameters</span>

        <span class="c1"># Parse it</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">yaml_string</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">dct</span><span class="p">[</span><span class="s2">&quot;__doc__&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">yaml_string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">):</span>
                <span class="n">yaml_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;---</span><span class="se">\n</span><span class="si">{</span><span class="n">yaml_string</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">function_definition</span> <span class="o">=</span> <span class="n">my_yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                <span class="n">yaml_string</span><span class="p">,</span>
                <span class="n">Loader</span><span class="o">=</span><span class="n">my_yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="n">ReaderError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Docstring parsing has failed. &quot;</span>
                <span class="s2">&quot;Did you remember to specify the docstring of </span><span class="si">%s</span><span class="s2"> as raw? &quot;</span>
                <span class="s2">&quot;To do that, you have to put a r before the docstring, &quot;</span>
<span class="w">                </span><span class="sd">&#39;&#39;&#39;like in \n\nr&quot;&quot;&quot;\n(docstring)\n&quot;&quot;&quot;\n\ninstead of just\n\n&#39;&#39;&#39;</span>
<span class="w">                </span><span class="sd">&#39;&#39;&#39;&quot;&quot;&quot;\ndocstring\n&quot;&quot;&quot;&#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">name</span>
            <span class="p">)</span>

            <span class="k">raise</span> <span class="n">DocstringIsNotRaw</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Store the function definition in the type</span>

            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;_function_definition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">function_definition</span>

        <span class="c1"># Enforce the presence of a description and of a parameters dictionary</span>

        <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">function_definition</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;You have to provide a &#39;description&#39; token in the &quot;</span>
                <span class="s2">&quot;documentation of class </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span>
            <span class="p">)</span>

            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;parameters&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">function_definition</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;You have to provide a &#39;parameters&#39; token in the &quot;</span>
                <span class="s2">&quot;documentation of class </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span>
            <span class="p">)</span>

            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">()</span>

        <span class="c1"># If there is a latex formula, store it in the type</span>

        <span class="k">if</span> <span class="s2">&quot;latex&quot;</span> <span class="ow">in</span> <span class="n">function_definition</span><span class="p">:</span>

            <span class="c1"># First remove the escaping we did to overcome the limitation of the YAML</span>
            <span class="c1"># parser</span>

            <span class="n">latex_formula</span> <span class="o">=</span> <span class="n">function_definition</span><span class="p">[</span><span class="s2">&quot;latex&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">92</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">latex_formula</span> <span class="o">=</span> <span class="n">NO_LATEX_FORMULA</span>

        <span class="c1"># Store latex formula in the type</span>
        <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;_latex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latex_formula</span>

        <span class="c1"># see if we have any properties</span>
        <span class="k">if</span> <span class="s2">&quot;properties&quot;</span> <span class="ow">in</span> <span class="n">function_definition</span><span class="p">:</span>

            <span class="c1"># parse the properties</span>

            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;_properties&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">property_name</span><span class="p">,</span> <span class="n">property_definition</span> <span class="ow">in</span> <span class="n">function_definition</span><span class="p">[</span>
                <span class="s2">&quot;properties&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="n">this_property</span> <span class="o">=</span> <span class="n">FunctionMeta</span><span class="o">.</span><span class="n">parse_property_definition</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">property_name</span><span class="p">,</span> <span class="n">property_definition</span>
                <span class="p">)</span>

                <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;_properties&quot;</span><span class="p">][</span><span class="n">this_property</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_property</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;_properties&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Parse the parameters&#39; dictionary</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">function_definition</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Wrong syntax in &#39;parameters&#39; token. It must be &quot;</span>
                <span class="s2">&quot;a dictionary. Refer to the documentation.&quot;</span>
            <span class="p">)</span>

            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">()</span>

        <span class="c1"># Add the parameters as attribute of the *type*. During the __call__ method</span>
        <span class="c1"># below this dictionary will be used to create a copy of each parameter which</span>
        <span class="c1"># will be made available as child of the *instance*.</span>

        <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;_parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">parameter_name</span><span class="p">,</span> <span class="n">parameter_definition</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">function_definition</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">):</span>

            <span class="k">if</span> <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;_properties&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">parameter_name</span> <span class="ow">in</span> <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;_properties&quot;</span><span class="p">]:</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;you must specify unique parameters and propert names&quot;</span><span class="p">)</span>

                    <span class="k">raise</span> <span class="n">DesignViolation</span><span class="p">()</span>

            <span class="n">this_parameter</span> <span class="o">=</span> <span class="n">FunctionMeta</span><span class="o">.</span><span class="n">parse_parameter_definition</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">parameter_name</span><span class="p">,</span> <span class="n">parameter_definition</span>
            <span class="p">)</span>

            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;_parameters&quot;</span><span class="p">][</span><span class="n">this_parameter</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_parameter</span>

        <span class="c1"># Now perform a minimal check of the &#39;evaluate&#39; function</span>

        <span class="p">(</span>
            <span class="n">variables</span><span class="p">,</span>
            <span class="n">parameters_in_calling_sequence</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">FunctionMeta</span><span class="o">.</span><span class="n">check_calling_sequence</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;evaluate&quot;</span><span class="p">,</span> <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;evaluate&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Now check that all the parameters used in &#39;evaluate&#39; are part of the</span>
        <span class="c1"># documentation, and that there are no unused parameters</span>

        <span class="n">set1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">dct</span><span class="p">[</span><span class="s2">&quot;_parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">set2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">parameters_in_calling_sequence</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">set1</span> <span class="o">!=</span> <span class="n">set2</span><span class="p">:</span>

            <span class="c1"># The parameters are different. Figure out who is missing and raise an</span>
            <span class="c1"># exception accordingly</span>

            <span class="k">if</span> <span class="n">set1</span> <span class="o">&gt;</span> <span class="n">set2</span><span class="p">:</span>

                <span class="n">missing</span> <span class="o">=</span> <span class="n">set1</span> <span class="o">-</span> <span class="n">set2</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Parameters </span><span class="si">%s</span><span class="s2"> have init values but are&quot;</span> <span class="o">%</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;not used in &#39;evaluate&#39; in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">missing</span> <span class="o">=</span> <span class="n">set2</span> <span class="o">-</span> <span class="n">set1</span>

                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Parameters </span><span class="si">%s</span><span class="s2"> are used in &#39;evaluate&#39; but do&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;not have init values in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">raise</span> <span class="n">FunctionDefinitionError</span><span class="p">()</span>

        <span class="c1"># Figure out the dimensionality of this function</span>

        <span class="n">n_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>

        <span class="c1"># Store the dimensionality in the *type*</span>

        <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;_n_dim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_dim</span>

        <span class="c1"># Now add the constructor to the class, if it does not provide one</span>
        <span class="c1"># You shouldn&#39;t usually provide a constructor, that&#39;s only for advance uses</span>
        <span class="c1"># like the TemplateModel</span>

        <span class="k">if</span> <span class="s2">&quot;_custom_init_&quot;</span> <span class="ow">in</span> <span class="n">dct</span><span class="p">:</span>

            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;__init__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;_custom_init_&quot;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;__init__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FunctionMeta</span><span class="o">.</span><span class="n">class_init</span>

        <span class="c1"># Finally, add the info() method to the type so that it can be called even</span>
        <span class="c1"># without instancing the class</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">info</span><span class="p">():</span>

            <span class="n">repr_dict</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

            <span class="n">repr_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">function_definition</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s2">&quot;latex&quot;</span> <span class="ow">in</span> <span class="n">function_definition</span><span class="p">:</span>
                <span class="n">repr_dict</span><span class="p">[</span><span class="s2">&quot;formula&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">function_definition</span><span class="p">[</span><span class="s2">&quot;latex&quot;</span><span class="p">]</span>

            <span class="c1"># Add the description of each parameter and their current value</span>
            <span class="n">repr_dict</span><span class="p">[</span><span class="s2">&quot;default parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">parameter_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dct</span><span class="p">[</span><span class="s2">&quot;_parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

                <span class="n">repr_dict</span><span class="p">[</span><span class="s2">&quot;default parameters&quot;</span><span class="p">][</span><span class="n">parameter_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;_parameters&quot;</span><span class="p">][</span>
                    <span class="n">parameter_name</span>
                <span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;_properties&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="c1"># Add the description of each parameter and their current value</span>
                <span class="n">repr_dict</span><span class="p">[</span><span class="s2">&quot;default properties&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">property_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dct</span><span class="p">[</span><span class="s2">&quot;_properties&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

                    <span class="n">repr_dict</span><span class="p">[</span><span class="s2">&quot;default properties&quot;</span><span class="p">][</span><span class="n">property_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;_properties&quot;</span><span class="p">][</span>
                        <span class="n">property_name</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">has_ipython</span><span class="p">:</span>

                <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">dict_to_list</span><span class="p">(</span><span class="n">repr_dict</span><span class="p">,</span> <span class="n">html</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="nb">print</span><span class="p">(</span><span class="n">dict_to_list</span><span class="p">(</span><span class="n">repr_dict</span><span class="p">,</span> <span class="n">html</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

        <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

        <span class="c1"># Now call the __new__ of the &quot;type&quot; class (which then will call the __init__</span>
        <span class="c1"># of this metaclass)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">FunctionMeta</span><span class="p">,</span> <span class="n">mcs</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>

        <span class="c1"># This is the MetaClass init, which is called after the __new__ is done</span>

        <span class="c1"># Store the name of the function in the type</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="c1"># Add this as a known function</span>

        <span class="n">_known_functions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span>

        <span class="c1"># Finally call the init of the type class</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">FunctionMeta</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>

<div class="viewcode-block" id="FunctionMeta.class_init">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.FunctionMeta.class_init">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">class_init</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># This is what is going to be called as the __init__ of the class, every time a</span>
        <span class="c1"># new instance is created</span>

        <span class="c1"># Create a copy of the parameters dictionary which is in the type,</span>
        <span class="c1"># otherwise every instance would share the same dictionary</span>

        <span class="n">copy_of_parameters</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

        <span class="c1"># Fill it by duplicating the parameters contained in the dictionary in the type</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">_parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="n">copy_of_parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">duplicate</span><span class="p">()</span>

            <span class="c1"># If the user has specified a value in the constructor, update the</span>
            <span class="c1"># corresponding parameters value. This allow to use a constructor as:</span>
            <span class="c1"># my_powerlaw = powerlaw(logK=1.0, index=-2)</span>

            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>

                <span class="n">copy_of_parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># now we check to see if there are any properties</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">_properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">copy_of_properties</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="n">copy_of_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">duplicate</span><span class="p">()</span>

                <span class="c1"># now we see if it was a deferred value and fail</span>
                <span class="c1"># if it was no specified in the constructor</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">copy_of_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">is_deferred</span>
                    <span class="ow">and</span> <span class="n">copy_of_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="p">):</span>

                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> is not specified as a deferred parameter, but no&quot;</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; value was specfied in the constructor of &quot;</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                        <span class="k">raise</span> <span class="n">FunctionInstanceError</span><span class="p">()</span>

                <span class="c1"># If the user has specified a value in the constructor, update the</span>
                <span class="c1"># corresponding parameters value. This allow to use a constructor as:</span>
                <span class="c1"># my_powerlaw = powerlaw(logK=1.0, index=-2)</span>

                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>

                    <span class="n">copy_of_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">copy_of_properties</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Now check that all the parameters specified in the kwargs are actually</span>
        <span class="c1"># parameters of this function</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="n">copy_of_parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">copy_of_properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="k">try</span><span class="p">:</span>

                        <span class="n">copy_of_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;You specified an init value for </span><span class="si">%s</span><span class="s2">, which is not a &quot;</span>
                            <span class="s2">&quot;parameter of function </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                        <span class="p">)</span>

                        <span class="k">raise</span> <span class="n">UnknownParameter</span><span class="p">()</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;You specified an init value for </span><span class="si">%s</span><span class="s2">, which is not a &quot;</span>
                        <span class="s2">&quot;parameter of function </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                    <span class="p">)</span>

                    <span class="k">raise</span> <span class="n">UnknownParameter</span><span class="p">()</span>

        <span class="c1"># Now call the init of the corresponding class</span>
        <span class="n">n_dim</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">_n_dim</span>

        <span class="k">if</span> <span class="n">n_dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

            <span class="n">Function1D</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="n">instance</span><span class="p">,</span>
                <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">_function_definition</span><span class="p">,</span>
                <span class="n">copy_of_parameters</span><span class="p">,</span>
                <span class="n">copy_of_properties</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">n_dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>

            <span class="n">Function2D</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="n">instance</span><span class="p">,</span>
                <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">_function_definition</span><span class="p">,</span>
                <span class="n">copy_of_parameters</span><span class="p">,</span>
                <span class="n">copy_of_properties</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">n_dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>

            <span class="n">Function3D</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="n">instance</span><span class="p">,</span>
                <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">_function_definition</span><span class="p">,</span>
                <span class="n">copy_of_parameters</span><span class="p">,</span>
                <span class="n">copy_of_properties</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Last, if the class provides a setup method, call it</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;_setup&quot;</span><span class="p">):</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;running setup of </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">instance</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span></div>


<div class="viewcode-block" id="FunctionMeta.check_calling_sequence">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.FunctionMeta.check_calling_sequence">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_calling_sequence</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">possible_variables</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check the calling sequence for the function looking for the</span>
<span class="sd">        variables specified. One or more of the variables can be in the calling</span>
<span class="sd">        sequence. Note that the order of the variables will be enforced. It</span>
<span class="sd">        will also enforce that the first parameter in the calling sequence is</span>
<span class="sd">        called &#39;self&#39;.</span>

<span class="sd">        :param function: the function to check</span>
<span class="sd">        :param possible_variables: a list of variables to check, The</span>
<span class="sd">            order is important, and will be enforced</span>
<span class="sd">        :return: a tuple containing the list of found variables, and the</span>
<span class="sd">            name of the other parameters in the calling sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get calling sequence</span>

        <span class="c1"># If the function has been memoized, it will have a &quot;input_object&quot; member</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">calling_sequence</span> <span class="o">=</span> <span class="n">_py2to3_getargspec</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="n">input_object</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>

        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>

            <span class="c1"># This might happen if the function is without memoization</span>

            <span class="n">calling_sequence</span> <span class="o">=</span> <span class="n">_py2to3_getargspec</span><span class="p">(</span><span class="n">function</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">calling_sequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;self&quot;</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Wrong syntax for &#39;evaluate&#39; in </span><span class="si">%s</span><span class="s2">. The first argument &quot;</span>
                <span class="s2">&quot;should be called &#39;self&#39;.&quot;</span> <span class="o">%</span> <span class="n">name</span>
            <span class="p">)</span>

            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">()</span>

        <span class="c1"># Figure out how many variables are used</span>

        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">calling_sequence</span> <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">possible_variables</span><span class="p">]</span>

        <span class="c1"># Check that they actually make sense. They must be used in the same order</span>
        <span class="c1"># as specified in possible_variables</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;The name of the variables for &#39;evaluate&#39; in </span><span class="si">%s</span><span class="s2"> must be one or more &quot;</span>
                <span class="s2">&quot;among </span><span class="si">%s</span><span class="s2">, instead of </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">possible_variables</span><span class="p">),</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">variables</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">variables</span> <span class="o">!=</span> <span class="n">possible_variables</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)]:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;The variables </span><span class="si">%s</span><span class="s2"> are out of order in &#39;</span><span class="si">%s</span><span class="s2">&#39; of </span><span class="si">%s</span><span class="s2">. Should be </span><span class="si">%s</span><span class="s2">.&quot;</span>
                <span class="o">%</span> <span class="p">(</span>
                    <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">variables</span><span class="p">),</span>
                    <span class="n">function_name</span><span class="p">,</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">possible_variables</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)],</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">()</span>

        <span class="n">other_parameters</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">calling_sequence</span> <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variables</span> <span class="ow">and</span> <span class="n">var</span> <span class="o">!=</span> <span class="s2">&quot;self&quot;</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">variables</span><span class="p">,</span> <span class="n">other_parameters</span></div>


<div class="viewcode-block" id="FunctionMeta.parse_parameter_definition">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.FunctionMeta.parse_parameter_definition">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse_parameter_definition</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">par_name</span><span class="p">,</span> <span class="n">definition</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Parameter</span><span class="p">:</span>

        <span class="c1"># Parse definition of parameter</span>

        <span class="c1"># Enforce the presence of attributes &#39;value&#39; and &#39;desc&#39;</span>

        <span class="k">if</span> <span class="s2">&quot;initial value&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">definition</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Error for parameter </span><span class="si">%s</span><span class="s2"> of function </span><span class="si">%s</span><span class="s2">: value for parameter must be&quot;</span>
                <span class="s2">&quot; specified&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">par_name</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">raise</span> <span class="n">FunctionDefinitionError</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;desc&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">definition</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Error for parameter </span><span class="si">%s</span><span class="s2"> of function </span><span class="si">%s</span><span class="s2">: desc for parameter must be&quot;</span>
                <span class="s2">&quot; specified&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">par_name</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">raise</span> <span class="n">FunctionDefinitionError</span><span class="p">()</span>

        <span class="c1"># Fetch attributes</span>

        <span class="c1"># Use unitless parameters when building the function, if no unit is specified,</span>
        <span class="c1"># otherwise use that unit</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;unit&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">definition</span>
            <span class="ow">or</span> <span class="n">definition</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">definition</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
        <span class="p">):</span>

            <span class="n">du</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">definition</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span><span class="o">.</span><span class="n">physical_type</span> <span class="o">==</span> <span class="n">unit</span><span class="o">.</span><span class="n">physical_type</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">unit</span><span class="o">.</span><span class="n">scale</span> <span class="o">!=</span> <span class="mi">1</span>
            <span class="p">):</span>

                <span class="c1"># some xpsec models list the unit as a number</span>
                <span class="c1"># but this screws things up</span>

                <span class="n">du</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">du</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">definition</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">])</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_parse_value</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>

                <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">_parse_value</span><span class="p">(</span><span class="n">definition</span><span class="p">[</span><span class="s2">&quot;initial value&quot;</span><span class="p">])</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="n">definition</span><span class="p">[</span><span class="s2">&quot;desc&quot;</span><span class="p">]</span>

        <span class="c1"># Optional attributes are either None if not specified, or the value specified</span>

        <span class="n">min_value</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="s2">&quot;min&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">definition</span> <span class="k">else</span> <span class="n">_parse_value</span><span class="p">(</span><span class="n">definition</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">])</span>
        <span class="n">max_value</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="s2">&quot;max&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">definition</span> <span class="k">else</span> <span class="n">_parse_value</span><span class="p">(</span><span class="n">definition</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">])</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="s2">&quot;delta&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">definition</span> <span class="k">else</span> <span class="n">_parse_value</span><span class="p">(</span><span class="n">definition</span><span class="p">[</span><span class="s2">&quot;delta&quot;</span><span class="p">])</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">du</span>

        <span class="c1"># A parameter can be fixed by using fix=yes, otherwise it is free by default</span>

        <span class="n">free</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="s2">&quot;fix&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">definition</span> <span class="k">else</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">definition</span><span class="p">[</span><span class="s2">&quot;fix&quot;</span><span class="p">])</span>

        <span class="n">is_normalization</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">False</span>
            <span class="k">if</span> <span class="s2">&quot;is_normalization&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">definition</span>
            <span class="k">else</span> <span class="nb">bool</span><span class="p">(</span><span class="n">definition</span><span class="p">[</span><span class="s2">&quot;is_normalization&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="n">transformation</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span>
            <span class="k">if</span> <span class="s2">&quot;transformation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">definition</span>
            <span class="k">else</span> <span class="n">get_transformation</span><span class="p">(</span><span class="n">definition</span><span class="p">[</span><span class="s2">&quot;transformation&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="n">new_parameter</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">par_name</span><span class="p">,</span>
            <span class="n">value</span><span class="p">,</span>
            <span class="n">min_value</span><span class="o">=</span><span class="n">min_value</span><span class="p">,</span>
            <span class="n">max_value</span><span class="o">=</span><span class="n">max_value</span><span class="p">,</span>
            <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
            <span class="n">free</span><span class="o">=</span><span class="n">free</span><span class="p">,</span>
            <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span>
            <span class="n">is_normalization</span><span class="o">=</span><span class="n">is_normalization</span><span class="p">,</span>
            <span class="n">transformation</span><span class="o">=</span><span class="n">transformation</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">new_parameter</span></div>


<div class="viewcode-block" id="FunctionMeta.parse_property_definition">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.FunctionMeta.parse_property_definition">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse_property_definition</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">,</span> <span class="n">definition</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionProperty</span><span class="p">:</span>

        <span class="c1"># Parse definition of parameter</span>

        <span class="c1"># see if we required a value at class construction</span>

        <span class="n">deferred</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="s2">&quot;defer&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">definition</span> <span class="k">else</span> <span class="nb">bool</span><span class="p">(</span><span class="n">definition</span><span class="p">[</span><span class="s2">&quot;defer&quot;</span><span class="p">])</span>

        <span class="c1"># Enforce the presence of attributes &#39;value&#39; and &#39;desc&#39;</span>

        <span class="k">if</span> <span class="s2">&quot;initial value&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">definition</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">deferred</span><span class="p">:</span>

                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Error for property </span><span class="si">%s</span><span class="s2"> of function </span><span class="si">%s</span><span class="s2">: value for parameter must be&quot;</span>
                    <span class="s2">&quot; specified&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prop_name</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="k">raise</span> <span class="n">FunctionDefinitionError</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;desc&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">definition</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Error for property </span><span class="si">%s</span><span class="s2"> of function </span><span class="si">%s</span><span class="s2">: desc for parameter must be&quot;</span>
                <span class="s2">&quot; specified&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prop_name</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">raise</span> <span class="n">FunctionDefinitionError</span><span class="p">()</span>

        <span class="c1"># get the allowed values</span>

        <span class="n">allowed_values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;allowed values&quot;</span> <span class="ow">in</span> <span class="n">definition</span><span class="p">:</span>

            <span class="n">allowed_values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">definition</span><span class="p">[</span><span class="s2">&quot;allowed values&quot;</span><span class="p">]:</span>

                <span class="n">allowed_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

        <span class="k">if</span> <span class="s2">&quot;function&quot;</span> <span class="ow">in</span> <span class="n">definition</span><span class="p">:</span>

            <span class="n">eval_func</span> <span class="o">=</span> <span class="n">definition</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">eval_func</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">deferred</span><span class="p">:</span>

            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">definition</span><span class="p">[</span><span class="s2">&quot;initial value&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">allowed_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_values</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error for property </span><span class="si">{</span><span class="n">prop_name</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> is&quot;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;not in </span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">allowed_values</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                    <span class="k">raise</span> <span class="n">FunctionDefinitionError</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">desc</span> <span class="o">=</span> <span class="n">definition</span><span class="p">[</span><span class="s2">&quot;desc&quot;</span><span class="p">]</span>

        <span class="n">new_property</span> <span class="o">=</span> <span class="n">FunctionProperty</span><span class="p">(</span>
            <span class="n">prop_name</span><span class="p">,</span>
            <span class="n">desc</span><span class="p">,</span>
            <span class="n">value</span><span class="p">,</span>
            <span class="n">allowed_values</span><span class="p">,</span>
            <span class="n">defer</span><span class="o">=</span><span class="n">deferred</span><span class="p">,</span>
            <span class="n">eval_func</span><span class="o">=</span><span class="n">eval_func</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">new_property</span></div>
</div>



<div class="viewcode-block" id="Function">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Function</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generic Function class.</span>

<span class="sd">    Will be subclassed in Function1D, Function2D and Function3D.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">function_definition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FunctionProperty</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="c1"># I use default values only to avoid warnings from pycharm and other software</span>
        <span class="c1"># about the calling sequence of this contructor. We actually need to enforce its</span>
        <span class="c1"># proper use, with this assert</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">function_definition</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;improper call&quot;</span><span class="p">)</span>

            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">()</span>

        <span class="c1"># Set up the node</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Function</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Store name, number of dimensions and the latex formula</span>

        <span class="c1"># Store also the function definition</span>

        <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">function_definition</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Function definition must contain a description&quot;</span><span class="p">)</span>

            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;latex&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">function_definition</span><span class="p">:</span>

            <span class="n">function_definition</span><span class="p">[</span><span class="s2">&quot;latex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$n.a.$&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_function_definition</span> <span class="o">=</span> <span class="n">function_definition</span>

        <span class="c1"># Add the parameters as children. Since the name of the key in the dictionary</span>
        <span class="c1"># might be different than the actual name of the parameter, use the .add_child</span>
        <span class="c1"># method instead of the add_children method</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">child_name</span><span class="p">,</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="n">child_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">child</span>

            <span class="c1"># Add the parameter as a child of the function</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_add_child</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

        <span class="c1"># Now add the properties if there are any</span>

        <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FunctionProperty</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">child_name</span><span class="p">,</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">[</span><span class="n">child_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">child</span>

                <span class="c1"># Add the parameter as a child of the function</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_add_child</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Now generate a unique identifier (UUID) in a thread safe, multi-processing</span>
        <span class="c1"># safe way. This is used for example in the CompositeFunction class to keep</span>
        <span class="c1"># track of the different instances of the same function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uuid</span> <span class="o">=</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_uuid</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="c1"># Normal functions are able to change units, while some specific ones (such as</span>
        <span class="c1"># the one from XSpec) are not. In this second case, this variable will contain</span>
        <span class="c1"># a tuple (x_unit, y_unit), but by default it should be None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_units</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_prior</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># stores any extrernally linked functions</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_external_functions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Function&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">n_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: number of dimensions for this function (1, 2 or 3)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_n_dim</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">free_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a dictionary of free parameters for this function.</span>

<span class="sd">        :return: dictionary of free parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">free_parameters</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">free</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">free_parameters</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_free_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns True or False depending on if any parameters are free.&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">free</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Parameter</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a tuple of parameters similar to get_children but for</span>
<span class="sd">        functions.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">properties</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FunctionProperty</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the properties of the function.</span>

<span class="sd">        :returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<div class="viewcode-block" id="Function.link_external_function">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function.link_external_function">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">link_external_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="s2">&quot;Function&quot;</span><span class="p">,</span> <span class="n">internal_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Link and external function to this function for use in its evaluate</span>
<span class="sd">        method. the function can be from another source.</span>

<span class="sd">        the linked function can be accessed via</span>
<span class="sd">        self.external_functions[internal_name]</span>

<span class="sd">        :param function: the function to link.</span>
<span class="sd">        :type function: &quot;Function&quot;</span>
<span class="sd">        :param internal_name: the internal name used to access this in</span>
<span class="sd">            the external_functions dict</span>
<span class="sd">        :type internal_name: str</span>
<span class="sd">        :returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">Function</span><span class="p">):</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;external functions must be of type Function&quot;</span><span class="p">)</span>

            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">internal_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_functions</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;a function with internal name </span><span class="si">{</span><span class="n">internal_name</span><span class="si">}</span><span class="s2"> is already linked!&quot;</span>
            <span class="p">)</span>

            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_external_functions</span><span class="p">[</span><span class="n">internal_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">function</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has now linked </span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">internal_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Function.unlink_external_function">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function.unlink_external_function">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">unlink_external_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">internal_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Unlink an external function.</span>

<span class="sd">        :param internal_name:</span>
<span class="sd">        :type internal_name: str</span>
<span class="sd">        :returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">internal_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_functions</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">internal_name</span><span class="si">}</span><span class="s2"> is not linked.&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Have </span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_external_functions</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_external_functions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">internal_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="Function.unlink_all_external_functions">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function.unlink_all_external_functions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">unlink_all_external_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Unlinks all external functions from this function.</span>

<span class="sd">        :returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_external_functions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_external_functions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">external_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_functions</span>

<div class="viewcode-block" id="Function.to_dict">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function.to_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minimal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>

        <span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Function</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">minimal</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">minimal</span><span class="p">:</span>

            <span class="c1"># link the external functions</span>
            <span class="c1"># by there internal name and</span>
            <span class="c1"># their path</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_functions</span><span class="p">:</span>

                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;external_functions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_functions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;external_functions&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">path</span>

        <span class="k">return</span> <span class="n">data</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_uuid</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a unique identifier for this function.</span>

<span class="sd">        :return: the UUID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="n">version</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<div class="viewcode-block" id="Function.has_fixed_units">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function.has_fixed_units">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_fixed_units</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns True if this function cannot change units, which is the case</span>
<span class="sd">        only for very specific functions (like models from foreign libraries</span>
<span class="sd">        like Xspec)</span>

<span class="sd">        :return: True or False</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixed_units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns False by default and must be overrided in the prior</span>
<span class="sd">        functions.</span>

<span class="sd">        :return: True or False</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_prior</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fixed_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the fixed units if has_fixed_units is True (see</span>
<span class="sd">        has_fixed_units)</span>

<span class="sd">        :return: None, or a tuple (x_unit, y_unit)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_units</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a description for this function.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_definition</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span>

    <span class="c1"># Add a property returning the parameters dictionary</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a dictionary of parameters.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">latex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the LaTEX formula for this function.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_definition</span><span class="p">[</span><span class="s2">&quot;latex&quot;</span><span class="p">]</span>

    <span class="c1"># Define now all the operators which allow to combine functions. Each operator will</span>
    <span class="c1"># return a new instance of a CompositeFunction, which can then be used as a function</span>
    <span class="c1"># on its own</span>

<div class="viewcode-block" id="Function.of">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function.of">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">of</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">another_function</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compose this function with another as in</span>
<span class="sd">        this_function(another_function(x)) :param another_function: another</span>
<span class="sd">        function to compose with the current one :return: a composite function</span>
<span class="sd">        instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">CompositeFunction</span><span class="p">(</span><span class="s2">&quot;of&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">another_function</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">CompositeFunction</span><span class="p">(</span><span class="s2">&quot;*-&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__abs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">CompositeFunction</span><span class="p">(</span><span class="s2">&quot;abs&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__pow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_instance</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">CompositeFunction</span><span class="p">(</span><span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">other_instance</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__rpow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_instance</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">CompositeFunction</span><span class="p">(</span><span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="n">other_instance</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_instance</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">CompositeFunction</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">other_instance</span><span class="p">)</span>

    <span class="fm">__radd__</span> <span class="o">=</span> <span class="fm">__add__</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_instance</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">CompositeFunction</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">other_instance</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__rsub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_instance</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">CompositeFunction</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">other_instance</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_instance</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">CompositeFunction</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">other_instance</span><span class="p">)</span>

        <span class="c1"># If the other instance is a function (and not a number), flag it so its units</span>
        <span class="c1"># will be made dimensionless in the set_units method of the composite function</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other_instance</span><span class="p">,</span> <span class="n">Function</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_fixed_units</span><span class="p">():</span>

                <span class="c1"># This is likely a XSpec model. The multiplication of two models with</span>
                <span class="c1"># units will give the wrong units to the results. So, depending on the</span>
                <span class="c1"># type of the first and second model, we need to adjust their units so</span>
                <span class="c1"># that the result will keep the right units.</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixed_units</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span><span class="p">:</span>

                    <span class="c1"># This function has fixed unit and is not dimensionless (likely an</span>
                    <span class="c1"># additive XSpec model). We need to make the other function</span>
                    <span class="c1"># dimensionless so that the multiplication of them will keep the</span>
                    <span class="c1"># right units</span>

                    <span class="n">other_instance</span><span class="o">.</span><span class="n">_make_dimensionless</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">other_instance</span><span class="si">}</span><span class="s2"> is not dimensionless&quot;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="c1"># This function has fixed unit, but it is dimensionless (likely a</span>
                    <span class="c1"># multiplicative XSpec model) The other function should keep its</span>
                    <span class="c1"># units, so we flag self instead</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_make_dimensionless</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{self}</span><span class="s2"> is now dimensionless&quot;</span><span class="p">)</span>

                    <span class="c1"># However, if also the other function has fixed dimension and it is</span>
                    <span class="c1"># dimensionless (likely another XSpec multiplicative model) we need</span>
                    <span class="c1"># to flag that as well</span>
                    <span class="k">if</span> <span class="n">other_instance</span><span class="o">.</span><span class="n">has_fixed_units</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">other_instance</span><span class="o">.</span><span class="n">fixed_units</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="o">==</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span>
                    <span class="p">):</span>
                        <span class="n">other_instance</span><span class="o">.</span><span class="n">_make_dimensionless</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="c1"># Now we need to flag the composite function as fixed units and</span>
                        <span class="c1"># dimensionless</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">_fixed_units</span> <span class="o">=</span> <span class="n">other_instance</span><span class="o">.</span><span class="n">fixed_units</span>

                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is completely dimensionless&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># We need to make the other instance dimensionless so that this function</span>
                <span class="c1"># (which is not dimensionless) multiplied by the other function (which</span>
                <span class="c1"># we will make dimensionless) will give the right units as the results</span>

                <span class="n">other_instance</span><span class="o">.</span><span class="n">_make_dimensionless</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">other_instance</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is not dimensionless&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">c</span>

    <span class="fm">__rmul__</span> <span class="o">=</span> <span class="fm">__mul__</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__div__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_instance</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">CompositeFunction</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">other_instance</span><span class="p">)</span>

        <span class="c1"># If the other instance is a function (and not a number), flag it so its units</span>
        <span class="c1"># will be made dimensionless in the set_units method of the composite function</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other_instance</span><span class="p">,</span> <span class="n">Function</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_fixed_units</span><span class="p">():</span>

                <span class="c1"># This is likely a XSpec model. Division is not supported.</span>

                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Division for XSpec models is not supported&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># We need to make the other instance dimensionless</span>

                <span class="n">other_instance</span><span class="o">.</span><span class="n">_make_dimensionless</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">c</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__rdiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_instance</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">CompositeFunction</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">other_instance</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="fm">__truediv__</span> <span class="o">=</span> <span class="n">__div__</span>
    <span class="fm">__rtruediv__</span> <span class="o">=</span> <span class="n">__rdiv__</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_repr__base</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rich_output</span><span class="p">):</span>

        <span class="n">repr_dict</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

        <span class="n">repr_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_definition</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;latex&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_definition</span><span class="p">:</span>

            <span class="n">repr_dict</span><span class="p">[</span><span class="s2">&quot;formula&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_definition</span><span class="p">[</span><span class="s2">&quot;latex&quot;</span><span class="p">]</span>

        <span class="c1"># Add the description of each parameter and their current value</span>
        <span class="n">repr_dict</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_children</span><span class="p">():</span>

            <span class="n">repr_dict</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">parameter</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">dict_to_list</span><span class="p">(</span><span class="n">repr_dict</span><span class="p">,</span> <span class="n">rich_output</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">uuid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the ID of the current function. The ID is used by the</span>
<span class="sd">        CompositeFunction class to keep track of the unique instances of each</span>
<span class="sd">        function. It should not be used by the user for any specific purpose.</span>

<span class="sd">        :return: (none)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uuid</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;checking equality of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_uuid</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">o</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uuid</span> <span class="o">==</span> <span class="n">o</span><span class="o">.</span><span class="n">uuid</span>

<div class="viewcode-block" id="Function.duplicate">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function.duplicate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">duplicate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a copy of the current function with all the parameters equal</span>
<span class="sd">        to the current value.</span>

<span class="sd">        :return: a new copy of the function</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create a copy</span>

        <span class="n">function_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">function_copy</span></div>


<div class="viewcode-block" id="Function.get_boundaries">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function.get_boundaries">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the boundaries of this function. By default there is no</span>
<span class="sd">        boundary, but subclasses can override this.</span>

<span class="sd">        :return: a tuple of tuples containing the boundaries for each</span>
<span class="sd">            coordinate (ra_min, ra_max), (dec_min, dec_max)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;You have to implement this&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;You have to implement this&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Function.fast_call">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function.fast_call">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fast_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;You have to implement this&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Function.evaluate_at">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function.evaluate_at">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">parameter_specification</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate the function at the given x(,y,z) for the provided</span>
<span class="sd">        parameters, explicitly provided as part of the parameter_specification</span>
<span class="sd">        keywords.</span>

<span class="sd">        :param *args: :param **parameter_specification:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Set the parameters to the provided values</span>
        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">parameter_specification</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_get_child</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">parameter_specification</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span></div>


<div class="viewcode-block" id="Function.get_total_spatial_integral">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function.get_total_spatial_integral">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_total_spatial_integral</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the total integral (for 2D functions) or the integral over</span>
<span class="sd">        the spatial components (for 3D functions). needs to be implemented in</span>
<span class="sd">        subclasses.</span>

<span class="sd">        :return: an array of values of the integral (same dimension as</span>
<span class="sd">            z).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;You have to implement this&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Function1D">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function1D">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Function1D</span><span class="p">(</span><span class="n">Function</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">function_definition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FunctionProperty</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="n">Function</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">function_definition</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">properties</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_x_unit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y_unit</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Function1D.evaluate">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function1D.evaluate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;You have to re-implement this&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Function1D.set_units">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function1D.set_units">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_x_unit</span><span class="p">,</span> <span class="n">in_y_unit</span><span class="p">):</span>

        <span class="c1"># Transform None in input to &#39;&#39;, so that u.Unit() will generate a dimensionless</span>
        <span class="c1"># unit</span>

        <span class="n">in_x_unit</span> <span class="o">=</span> <span class="n">in_x_unit</span> <span class="k">if</span> <span class="n">in_x_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">in_y_unit</span> <span class="o">=</span> <span class="n">in_y_unit</span> <span class="k">if</span> <span class="n">in_y_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Get a Unit instance from the inputs</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">in_x_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">in_x_unit</span><span class="p">)</span>
            <span class="n">in_y_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">in_y_unit</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Could not get a Unit instance from provided units &quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">in_x_unit</span><span class="p">,</span><span class="w"> </span><span class="n">in_y_unit</span><span class="p">)</span><span class="si">}</span><span class="s2"> when setting units &quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> for function </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Now call the underlying method to set units, which is defined by each function</span>
        <span class="n">new_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_units</span><span class="p">(</span><span class="n">in_x_unit</span><span class="p">,</span> <span class="n">in_y_unit</span><span class="p">)</span>

        <span class="c1"># Store the units.</span>
        <span class="c1"># NOTE: the previous call to _set_units might return new units in special cases</span>
        <span class="c1"># (for example Xspec functions). So it is critical that we store them in the</span>
        <span class="c1"># class&#39; attributes after the call to _set_units</span>

        <span class="k">if</span> <span class="n">new_units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">new_x_unit</span><span class="p">,</span> <span class="n">new_y_unit</span> <span class="o">=</span> <span class="n">new_units</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_x_unit</span> <span class="o">=</span> <span class="n">new_x_unit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_y_unit</span> <span class="o">=</span> <span class="n">new_y_unit</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_x_unit</span> <span class="o">=</span> <span class="n">in_x_unit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_y_unit</span> <span class="o">=</span> <span class="n">in_y_unit</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_set_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_unit</span><span class="p">,</span> <span class="n">y_unit</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>

        <span class="c1"># This will be overridden by derived classes</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;You have to implement the method _set_units for function </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">x_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The unit of the independent variable :return: a astropy.Unit</span>
<span class="sd">        instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_unit</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">y_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The unit of the dependent variable :return: a astropy.Unit</span>
<span class="sd">        instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_unit</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>

        <span class="c1"># This method&#39;s code violates explicitly duck typing. The reason is that</span>
        <span class="c1"># astropy.units introduce a very significant overload on any computation. For</span>
        <span class="c1"># this reason we treat differently the case with units from the case without</span>
        <span class="c1"># units, so that the latter case remains fast. Also, transforming an input</span>
        <span class="c1"># which is not an array into an array introduce a significant overload</span>
        <span class="c1"># (10 microseconds or so), so we perform this transformation only when strictly</span>
        <span class="c1"># required</span>

        <span class="c1"># NOTE: for a single quantity such as q = (1.0 * u.keV),</span>
        <span class="c1"># isinstance(q, np.ndarray) returns True</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>

            <span class="c1"># We have an array as input (or a single quantity)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>

                <span class="c1"># This is a normal array, let&#39;s use the fast call (without units)</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast_call</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># This is an array with units or a single quantity, let&#39;s use the slow</span>
                <span class="c1"># call which preserves units</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_unit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;In order to use units you need to use the function as a &quot;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;spectrum or as something else, or you need to explicitly&quot;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; set the units.&quot;</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">()</span>

                <span class="c1"># we want to make sure this is an array</span>

                <span class="n">new_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

                <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_with_units</span><span class="p">(</span><span class="n">new_input</span><span class="p">)</span>

                <span class="c1"># Now convert to the expected y unit and return a astropy.Quantity by</span>
                <span class="c1"># multiplying by the right unit</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_unit</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_unit</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># This is either a single number or a list</span>

            <span class="c1"># Transform the input to an array of floats. If x is a single number, this</span>
            <span class="c1"># will be an array of size 1</span>

            <span class="n">new_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy_if_needed</span><span class="p">)</span>

            <span class="c1"># Compute the function</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast_call</span><span class="p">(</span><span class="n">new_input</span><span class="p">)</span>

            <span class="c1"># Now remove all dimensions of size 1. For example, an array of shape (1,)</span>
            <span class="c1"># will become a single number, so that if the input was a single number,</span>
            <span class="c1"># also the output will be a single number</span>

            <span class="n">sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

            <span class="c1"># if this is still a list after all this work this its</span>
            <span class="c1"># shape will be</span>
            <span class="k">if</span> <span class="n">sq</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>

                <span class="k">return</span> <span class="n">sq</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># this is a single number and we assume it is a float</span>

                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">sq</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_call_with_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>

        <span class="c1"># Gather the current parameters&#39; values with units</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;as_quantity&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_parameters</span><span class="p">()))</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_unit</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">spectral</span><span class="p">()),</span> <span class="o">*</span><span class="n">values</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="n">u</span><span class="o">.</span><span class="n">UnitsError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>

            <span class="c1"># see if this is a dimensionless function</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_fixed_units</span><span class="p">():</span>

                <span class="k">try</span><span class="p">:</span>

                    <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_unit</span><span class="p">),</span> <span class="o">*</span><span class="n">values</span><span class="p">)</span>

                <span class="k">except</span> <span class="n">u</span><span class="o">.</span><span class="n">UnitsError</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Looks like you didn&#39;t provide all the units, or you provided&quot;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; the wrong ones, when calling function </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                    <span class="k">raise</span> <span class="n">u</span><span class="o">.</span><span class="n">UnitsError</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Looks like you didn&#39;t provide all the units, or you provided the&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; wrong ones, when calling function </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">()</span>

                <span class="k">raise</span> <span class="n">u</span><span class="o">.</span><span class="n">UnitsError</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">return</span> <span class="n">results</span>

<div class="viewcode-block" id="Function1D.fast_call">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function1D.fast_call">[docs]</a>
    <span class="nd">@memoize</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fast_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

        <span class="c1"># Gather the current parameters&#39; values without units, which means that the</span>
        <span class="c1"># whole computation will be without units, with a big speed gain (~10x)</span>

        <span class="c1"># NOTE: it is important to use value, and not _value, to support linking</span>

        <span class="c1"># values = list(map(attrgetter(&quot;value&quot;), self._get_children()))</span>

        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_parameters</span><span class="p">()))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">)</span></div>


<div class="viewcode-block" id="Function1D.get_boundaries">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function1D.get_boundaries">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the boundaries of this function. By default there is no</span>
<span class="sd">        boundary, but subclasses can override this.</span>

<span class="sd">        :return: a tuple of tuples containing the boundaries for each</span>
<span class="sd">            coordinate (ra_min, ra_max), (dec_min, dec_max)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot call get_boundaries() on a 1d function&quot;</span><span class="p">)</span>

        <span class="k">raise</span> <span class="n">DesignViolation</span><span class="p">()</span></div>


<div class="viewcode-block" id="Function1D.local_spectral_index">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function1D.local_spectral_index">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">local_spectral_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the local spectral index of the model at a given set of</span>
<span class="sd">        energies.</span>

<span class="sd">        :param x:</span>
<span class="sd">        :type energy:</span>
<span class="sd">        :param epsilon:</span>
<span class="sd">        :type epsilon:</span>
<span class="sd">        :returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">_local_deriv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span></div>
</div>



<span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_local_deriv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">b</span> <span class="o">/</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>


<div class="viewcode-block" id="Function2D">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function2D">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Function2D</span><span class="p">(</span><span class="n">Function</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">function_definition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FunctionProperty</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="n">Function</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">function_definition</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">properties</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_x_unit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y_unit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z_unit</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Function2D.evaluate">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function2D.evaluate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;You have to re-implement this&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Function2D.set_units">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function2D.set_units">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_x_unit</span><span class="p">,</span> <span class="n">in_y_unit</span><span class="p">,</span> <span class="n">in_z_unit</span><span class="p">):</span>

        <span class="c1"># Change None to &#39;&#39; for the inputs so that the following u.Unit construction</span>
        <span class="c1"># will generate a dimensionless# unit (it would fail with None)</span>

        <span class="n">in_x_unit</span> <span class="o">=</span> <span class="n">in_x_unit</span> <span class="k">if</span> <span class="n">in_x_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">in_y_unit</span> <span class="o">=</span> <span class="n">in_y_unit</span> <span class="k">if</span> <span class="n">in_y_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">in_z_unit</span> <span class="o">=</span> <span class="n">in_z_unit</span> <span class="k">if</span> <span class="n">in_z_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">in_x_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">in_x_unit</span><span class="p">)</span>
            <span class="n">in_y_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">in_y_unit</span><span class="p">)</span>
            <span class="n">in_z_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">in_z_unit</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Could not get a Unit instance from provided units when setting units &quot;</span>
            <span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">for function </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Store the Unit instances</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_x_unit</span> <span class="o">=</span> <span class="n">in_x_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y_unit</span> <span class="o">=</span> <span class="n">in_y_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z_unit</span> <span class="o">=</span> <span class="n">in_z_unit</span>

        <span class="c1"># Now call the underlying method to set units, which is defined by each function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_units</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x_unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_unit</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_set_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_unit</span><span class="p">,</span> <span class="n">y_unit</span><span class="p">,</span> <span class="n">z_unit</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>

        <span class="c1"># This will be overridden by derived classes</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;You have to implement the method _set_units for function </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">x_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_unit</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">y_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_unit</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">z_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_unit</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># This method&#39;s code violates explicitly duck typing. The reason is that</span>
        <span class="c1"># astropy.units introduce a very significant overload on any computation. For</span>
        <span class="c1"># this reason we treat differently the case with units from the case without</span>
        <span class="c1"># units, so that the latter case remains fast. Also, transforming an input which</span>
        <span class="c1"># is not an array into an array introduce a significant overload (10</span>
        <span class="c1"># microseconds or so), so we perform this transformation only when strictly</span>
        <span class="c1"># required</span>

        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="s2">&quot;You have to use the same type for x and y&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>

            <span class="c1"># We have an array or a quantity as input</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>

                <span class="c1"># This is a normal array, let&#39;s use the fast call (without units)</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_without_units</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># This is an array with units or a single quantity, let&#39;s use the slow</span>
                <span class="c1"># call which preserves units</span>

                <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_with_units</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

                <span class="c1"># Now convert to the expected z unit and remove useless dimensions</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_unit</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_unit</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># This is either a single number or a list</span>

            <span class="c1"># Transform the input to an array of floats</span>

            <span class="n">new_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy_if_needed</span><span class="p">)</span>
            <span class="n">new_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy_if_needed</span><span class="p">)</span>

            <span class="c1"># Compute the function</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_without_units</span><span class="p">(</span><span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span><span class="p">)</span>

            <span class="c1"># Now remove all dimensions of size 1. For example, an array of shape (1,)</span>
            <span class="c1"># will become a single number.</span>

            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_call_with_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>

        <span class="c1"># Gather the current parameters&#39; values with units</span>

        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;as_quantity&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_parameters</span><span class="p">()))</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">u</span><span class="o">.</span><span class="n">UnitsError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Looks like you didn&#39;t provide all the units, or you provided the wrong&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; ones, when calling function </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">raise</span> <span class="n">u</span><span class="o">.</span><span class="n">UnitsError</span><span class="p">(</span>
                <span class="s2">&quot;Looks like you didn&#39;t provide all the units, or you provided the wrong&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ones, when calling function </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">return</span> <span class="n">results</span>

    <span class="nd">@memoize</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_call_without_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>

        <span class="c1"># Gather the current parameters&#39; values without units, which means that the</span>
        <span class="c1"># whole computation will be without units, with a big speed gain (~10x)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_parameters</span><span class="p">()))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">)</span></div>



<div class="viewcode-block" id="Function3D">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function3D">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Function3D</span><span class="p">(</span><span class="n">Function</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">function_definition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FunctionProperty</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="n">Function</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">function_definition</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">properties</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_x_unit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y_unit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z_unit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_w_unit</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Function3D.evaluate">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function3D.evaluate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;You have to re-implement this&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Function3D.set_units">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.Function3D.set_units">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_x_unit</span><span class="p">,</span> <span class="n">in_y_unit</span><span class="p">,</span> <span class="n">in_z_unit</span><span class="p">,</span> <span class="n">in_w_unit</span><span class="p">):</span>

        <span class="c1"># Change None to &#39;&#39; for the inputs so that the following u.Unit construction</span>
        <span class="c1"># will generate a dimensionless unit (it would fail with None)</span>

        <span class="n">in_x_unit</span> <span class="o">=</span> <span class="n">in_x_unit</span> <span class="k">if</span> <span class="n">in_x_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">in_y_unit</span> <span class="o">=</span> <span class="n">in_y_unit</span> <span class="k">if</span> <span class="n">in_y_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">in_z_unit</span> <span class="o">=</span> <span class="n">in_z_unit</span> <span class="k">if</span> <span class="n">in_z_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">in_w_unit</span> <span class="o">=</span> <span class="n">in_w_unit</span> <span class="k">if</span> <span class="n">in_w_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Get instances of Unit</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">in_x_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">in_x_unit</span><span class="p">)</span>
            <span class="n">in_y_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">in_y_unit</span><span class="p">)</span>
            <span class="n">in_z_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">in_z_unit</span><span class="p">)</span>
            <span class="n">in_w_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">in_w_unit</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Could not get a Unit instance from provided units when setting units &quot;</span>
            <span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">for function </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Store the Unit instances</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_x_unit</span> <span class="o">=</span> <span class="n">in_x_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y_unit</span> <span class="o">=</span> <span class="n">in_y_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z_unit</span> <span class="o">=</span> <span class="n">in_z_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_w_unit</span> <span class="o">=</span> <span class="n">in_w_unit</span>

        <span class="c1"># Now call the underlying method to set units, which is defined by each function</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_units</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x_unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_w_unit</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_set_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_unit</span><span class="p">,</span> <span class="n">y_unit</span><span class="p">,</span> <span class="n">z_unit</span><span class="p">,</span> <span class="n">w_unit</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>

        <span class="c1"># This will be overridden by derived classes</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;You have to implement the method _set_units for function </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">x_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_unit</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">y_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_unit</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">z_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_unit</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">w_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_w_unit</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>

        <span class="c1"># This method&#39;s code violates explicitly duck typing. The reason is that</span>
        <span class="c1"># astropy.units introduce a very significant overload on any computation. For</span>
        <span class="c1"># this reason we treat differently the case with units from the case without</span>
        <span class="c1"># units, so that the latter case remains fast. Also, transforming an input which</span>
        <span class="c1"># is not an array into an array introduce a significant overload (10</span>
        <span class="c1"># microseconds or so), so we perform this transformation only when strictly</span>
        <span class="c1"># required</span>

        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span>
            <span class="n">z</span>
        <span class="p">),</span> <span class="s2">&quot;You have to use the same type for x, y and z&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>

            <span class="c1"># We have an array as input</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>

                <span class="c1"># This is a normal array, let&#39;s use the fast call (without units)</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_without_units</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># This is an array with units or a single quantity, let&#39;s use the slow</span>
                <span class="c1"># call which preserves units</span>

                <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_with_units</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

                <span class="c1"># Now convert to the expected w unit and remove useless dimensions</span>

                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_unit</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_unit</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># This is either a single number or a list</span>
            <span class="c1"># Transform the input to an array of floats</span>

            <span class="n">new_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy_if_needed</span><span class="p">)</span>
            <span class="n">new_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy_if_needed</span><span class="p">)</span>
            <span class="n">new_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy_if_needed</span><span class="p">)</span>

            <span class="c1"># Compute the function</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_without_units</span><span class="p">(</span><span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span><span class="p">,</span> <span class="n">new_z</span><span class="p">)</span>

            <span class="c1"># Now remove all dimensions of size 1. For example, an array of shape (1,)</span>
            <span class="c1"># will become a single number.</span>

            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_call_with_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>

        <span class="c1"># Gather the current parameters&#39; values with units</span>

        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;as_quantity&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_parameters</span><span class="p">()))</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">u</span><span class="o">.</span><span class="n">UnitsError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>

            <span class="k">raise</span> <span class="n">u</span><span class="o">.</span><span class="n">UnitsError</span><span class="p">(</span>
                <span class="s2">&quot;Looks like you didn&#39;t provide all the units, or you provided the wrong&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ones, when calling function </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">return</span> <span class="n">results</span>

    <span class="nd">@memoize</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_call_without_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>

        <span class="c1"># Gather the current parameters&#39; values without units, which means that the</span>
        <span class="c1"># whole computation will be without units, with a big speed gain (~10x)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_parameters</span><span class="p">()))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">)</span></div>



<span class="c1">##########################</span>
<span class="c1"># Composite function stuff</span>
<span class="c1">##########################</span>

<span class="c1"># Codes to indicate to Composite Function the operation between two functions</span>
<span class="n">_operations</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">,</span>
    <span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">,</span>
    <span class="s2">&quot;*-&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span>
    <span class="s2">&quot;*&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">,</span>
    <span class="s2">&quot;/&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">,</span>
    <span class="s2">&quot;**&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
    <span class="s2">&quot;abs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span>
    <span class="s2">&quot;of&quot;</span><span class="p">:</span> <span class="s2">&quot;compose&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="c1"># These methods need to be here to overcome the limitation of pickle with methods of</span>
<span class="c1"># classes</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_cf_evaluate_func_func</span><span class="p">(</span><span class="n">np_operator</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="c1"># Evaluate for when both elements are functions</span>

    <span class="k">return</span> <span class="n">np_operator</span><span class="p">(</span><span class="n">f1</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">),</span> <span class="n">f2</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_cf_evaluate_func_number</span><span class="p">(</span><span class="n">np_operator</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="c1"># Evaluate for when element 1 is a function and element 2 is a number</span>

    <span class="k">return</span> <span class="n">np_operator</span><span class="p">(</span><span class="n">f1</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">),</span> <span class="n">f2</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_cf_evaluate_number_func</span><span class="p">(</span><span class="n">np_operator</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="c1"># Evaluate for when element 2 is a function and element 1 is a number</span>

    <span class="k">return</span> <span class="n">np_operator</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_cf_evaluate_func_of_func</span><span class="p">(</span><span class="n">np_operator</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">f2</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">f1</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>


<div class="viewcode-block" id="CompositeFunction">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.CompositeFunction">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CompositeFunction</span><span class="p">(</span><span class="n">Function</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">function_or_scalar_1</span><span class="p">,</span> <span class="n">function_or_scalar_2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">operation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_operations</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Do not know operation </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">operation</span><span class="p">)</span>

            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">()</span>

        <span class="c1"># Save this to make the class pickeable (see the __setstate__ and</span>
        <span class="c1"># __getstate__ methods)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_calling_sequence</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">operation</span><span class="p">,</span>
            <span class="n">function_or_scalar_1</span><span class="p">,</span>
            <span class="n">function_or_scalar_2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_requested_x_unit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_requested_y_unit</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_operation</span> <span class="o">=</span> <span class="n">operation</span>

        <span class="c1"># Set the new __call__ according to the type of the elements in the expression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_decide_evaluate_type</span><span class="p">()</span>

        <span class="c1"># Save a description, but using the unique IDs of the functions involved, to</span>
        <span class="c1"># keep track of where they appear in the expression</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_uuid_expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_uuid_expression</span><span class="p">(</span>
            <span class="n">operation</span><span class="p">,</span> <span class="n">function_or_scalar_1</span><span class="p">,</span> <span class="n">function_or_scalar_2</span>
        <span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;UUID of composite </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_uuid_expression</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Makes the list of unique functions which compose this composite function.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_functions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">function</span> <span class="ow">in</span> <span class="p">[</span><span class="n">function_or_scalar_1</span><span class="p">,</span> <span class="n">function_or_scalar_2</span><span class="p">]:</span>

            <span class="c1"># Check whether this is already a composite function. If it is, add the</span>
            <span class="c1"># functions contained in it</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">CompositeFunction</span><span class="p">):</span>

                <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is a composite function&quot;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">sub_function</span> <span class="ow">in</span> <span class="n">function</span><span class="o">.</span><span class="n">functions</span><span class="p">:</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;checking sub function </span><span class="si">{</span><span class="n">sub_function</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">sub_function</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_functions</span><span class="p">:</span>

                        <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;now adding </span><span class="si">{</span><span class="n">sub_function</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_function</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">Function</span><span class="p">):</span>

                <span class="c1"># This is a simple function.</span>
                <span class="c1"># Add it only if it is not there already (avoid duplicate)</span>

                <span class="k">if</span> <span class="n">function</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_functions</span><span class="p">:</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is being added&quot;</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is a duplicate&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># This is a scalar, no need to add it among the functions</span>

                <span class="k">pass</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;comp now has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_functions</span><span class="p">)</span><span class="si">}</span><span class="s2"> functions&quot;</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;added functions are now </span><span class="si">{</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_functions</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Make sure all functions have the same dimension, and store it so that the</span>
        <span class="c1"># property .n_dim of the Function class will work</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_functions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">n_dim</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;CompositeFunction class can only handle 1-dimensional functions at the&quot;</span>
                <span class="s2">&quot; moment.&quot;</span>
            <span class="p">)</span>

            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">function</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_functions</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">function</span><span class="o">.</span><span class="n">n_dim</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">:</span>

                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You cannot compose functions of different dimensionality&quot;</span><span class="p">)</span>

                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">()</span>

        <span class="c1"># Now assign a unique name to all the functions,</span>
        <span class="c1"># to make clear which is which in the definition</span>
        <span class="c1"># and give an easy way for the user to understand</span>
        <span class="c1"># which parameter belongs to which function</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_id_to_uid</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uuid_expression</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">function</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_functions</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_id_to_uid</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">uuid</span>

            <span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="n">function</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">{</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Save the expression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expression</span> <span class="o">=</span> <span class="n">expression</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;function expression: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_expression</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Build the parameters dictionary assigning a new name to each parameter to</span>
        <span class="c1"># account for possible duplicates.</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

        <span class="n">properties</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sub_children</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;we now have </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_functions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">function</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_functions</span><span class="p">):</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;func path before comp: </span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">parameter_name</span><span class="p">,</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">function</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="c1"># New name to avoid possible duplicates</span>

                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;(.+)_[0-9]+$&quot;</span><span class="p">,</span> <span class="n">parameter_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="n">original_name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="n">original_name</span> <span class="o">=</span> <span class="n">parameter_name</span>

                <span class="n">new_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">original_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rename </span><span class="si">{</span><span class="n">original_name</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">new_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Store the parameter under the new name (obviously this is a reference</span>
                <span class="c1"># to the parameter, not a copy, as always in python)</span>

                <span class="n">parameters</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter</span>

                <span class="n">parameter</span><span class="o">.</span><span class="n">_change_name</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span> <span class="n">clear_parent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">function</span><span class="o">.</span><span class="n">properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="k">for</span> <span class="p">(</span>
                    <span class="n">property_name</span><span class="p">,</span>
                    <span class="n">function_property</span><span class="p">,</span>
                <span class="p">)</span> <span class="ow">in</span> <span class="n">function</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                    <span class="c1"># New name to avoid possible duplicates</span>

                    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;(.+)_[0-9]+$&quot;</span><span class="p">,</span> <span class="n">property_name</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                        <span class="n">original_name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>

                        <span class="n">original_name</span> <span class="o">=</span> <span class="n">property_name</span>

                    <span class="n">new_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">original_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rename </span><span class="si">{</span><span class="n">original_name</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">new_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># Store the parameter under the new name (obviously this is a</span>
                    <span class="c1"># reference to the parameter, not a copy, as always in python)</span>

                    <span class="n">properties</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">function_property</span>

                    <span class="n">function_property</span><span class="o">.</span><span class="n">_change_name</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span> <span class="n">clear_parent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="s2">&quot;function property name has changed&quot;</span><span class="p">)</span>

            <span class="c1"># now, some functions may have children and we want to keep track of those</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_sub_children</span><span class="p">[</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">child_name</span><span class="p">,</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">function</span><span class="o">.</span><span class="n">_children</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="k">if</span> <span class="n">child_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">function</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has child </span><span class="si">{</span><span class="n">child_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_sub_children</span><span class="p">[</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">child_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span>
                        <span class="n">minimal</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">function</span><span class="o">.</span><span class="n">is_root</span><span class="p">:</span>

                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> was previously assigned to &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">_root</span><span class="p">(</span><span class="n">source_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;it has now been removed as it is a composite&quot;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;you can create a new function and link it to the composite &quot;</span>
                    <span class="s2">&quot;parameters if needed&quot;</span>
                <span class="p">)</span>

                <span class="c1"># if the function is attached to a source, we want to ditch the source</span>
                <span class="c1"># because now this function is part of a composite</span>

                <span class="n">function</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_remove_child</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;func path after comp: </span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># reset properties if there were none</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">properties</span><span class="p">:</span>

            <span class="n">properties</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Now build a meaningful description</span>

        <span class="n">_function_definition</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span>
            <span class="s2">&quot;latex&quot;</span><span class="p">:</span> <span class="n">NO_LATEX_FORMULA</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">Function</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;composite&quot;</span><span class="p">,</span> <span class="n">_function_definition</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">properties</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uuid_expression</span>

<div class="viewcode-block" id="CompositeFunction.set_units">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.CompositeFunction.set_units">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_unit</span><span class="p">,</span> <span class="n">y_unit</span><span class="p">,</span> <span class="n">relaxed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">relaxed</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x_unit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y_unit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>

            <span class="c1"># This can happen when rebuilding a composite function during unpickling,</span>
            <span class="c1"># when there are more than two functions composed together. We do not need</span>
            <span class="c1"># to to anything in that case</span>
            <span class="k">pass</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_requested_x_unit</span> <span class="o">=</span> <span class="n">x_unit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_requested_y_unit</span> <span class="o">=</span> <span class="n">y_unit</span>

            <span class="c1"># Just rely on the single functions to adjust themselves.</span>

            <span class="k">for</span> <span class="n">function</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="p">:</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="s2">&quot;_make_dimensionless&quot;</span><span class="p">):</span>

                    <span class="n">function</span><span class="o">.</span><span class="n">set_units</span><span class="p">(</span><span class="n">x_unit</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="n">function</span><span class="o">.</span><span class="n">set_units</span><span class="p">(</span><span class="n">x_unit</span><span class="p">,</span> <span class="n">y_unit</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">expression</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expression</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_uuid_expression</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">name_1</span><span class="p">,</span> <span class="n">name_2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">name_2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">return</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">name_1</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">name_1</span><span class="p">,</span> <span class="s2">&quot;uuid&quot;</span><span class="p">):</span>

            <span class="n">name_1_uuid</span> <span class="o">=</span> <span class="n">name_1</span><span class="o">.</span><span class="n">uuid</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">name_1_uuid</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name_1</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">name_2</span><span class="p">,</span> <span class="s2">&quot;uuid&quot;</span><span class="p">):</span>

            <span class="n">name_2_uuid</span> <span class="o">=</span> <span class="n">name_2</span><span class="o">.</span><span class="n">uuid</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">name_2_uuid</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name_2</span>

        <span class="k">return</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name_1_uuid</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">name_2_uuid</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_decide_evaluate_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Assign to __call__ the right evaluate according to the type of the elements</span>
        <span class="c1"># in the expression</span>

        <span class="n">operation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calling_sequence</span>

        <span class="n">np_operator</span> <span class="o">=</span> <span class="n">_operations</span><span class="p">[</span><span class="n">operation</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_np_operator</span> <span class="o">=</span> <span class="n">np_operator</span>

        <span class="k">if</span> <span class="n">np_operator</span> <span class="o">==</span> <span class="s2">&quot;compose&quot;</span><span class="p">:</span>

            <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_f2</span><span class="p">,</span> <span class="s2">&quot;evaluate&quot;</span>
            <span class="p">),</span> <span class="s2">&quot;Second member of .of cannot be a scalar&quot;</span>

            <span class="k">assert</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_f1</span><span class="o">.</span><span class="n">n_dim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f2</span><span class="o">.</span><span class="n">n_dim</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="p">),</span> <span class="s2">&quot;Can only compose with .of functions of 1 variable&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span> <span class="o">=</span> <span class="n">_cf_evaluate_func_of_func</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Check whether the second member is a function, or a number</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f1</span><span class="p">,</span> <span class="s2">&quot;evaluate&quot;</span><span class="p">):</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f2</span><span class="p">,</span> <span class="s2">&quot;evaluate&quot;</span><span class="p">):</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span> <span class="o">=</span> <span class="n">_cf_evaluate_func_func</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span> <span class="o">=</span> <span class="n">_cf_evaluate_func_number</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f2</span><span class="p">,</span> <span class="s2">&quot;evaluate&quot;</span><span class="p">):</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span> <span class="o">=</span> <span class="n">_cf_evaluate_number_func</span>

                <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>

                    <span class="c1"># Should never get here!</span>

                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Should never get here&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;A list containing the function used to build this composite function&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_functions</span>

<div class="viewcode-block" id="CompositeFunction.evaluate">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.CompositeFunction.evaluate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;You cannot instance and use a composite function by itself. Use the &quot;</span>
            <span class="s2">&quot;factories.&quot;</span>
        <span class="p">)</span></div>


    <span class="c1"># This dumb function must be here because it is not possible to override at runtime</span>
    <span class="c1"># __call__ (nor any other special method)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_np_operator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f2</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="c1"># For composite function, fast_call is the same as __call__ (because the call will</span>
    <span class="c1"># be forwarded to the inner functions)</span>

    <span class="n">fast_call</span> <span class="o">=</span> <span class="fm">__call__</span>

    <span class="c1"># Override the to_dict method of the Node class to add the expression to re-build</span>
    <span class="c1"># this composite function</span>
<div class="viewcode-block" id="CompositeFunction.to_dict">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.CompositeFunction.to_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minimal</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CompositeFunction</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">minimal</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">minimal</span><span class="p">:</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;expression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expression</span>

            <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">for</span> <span class="n">function</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_functions</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">function</span><span class="o">.</span><span class="n">external_functions</span><span class="p">:</span>

                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>

                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;external_functions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">function</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_functions</span><span class="p">):</span>

                    <span class="n">this_function</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">function</span><span class="o">.</span><span class="n">external_functions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                        <span class="n">this_function</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">path</span>

                    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;external_functions&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_function</span>

        <span class="k">return</span> <span class="n">data</span></div>
</div>



<div class="viewcode-block" id="get_function">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.get_function">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_function</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">composite_function_expression</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the function &quot;name&quot;, which must be among the known functions or</span>
<span class="sd">    a composite function.</span>

<span class="sd">    :param function_name: the name of the function (use &#39;composite&#39; if</span>
<span class="sd">        the function is a composite function)</span>
<span class="sd">    :param composite_function_expression: composite function</span>
<span class="sd">        specification such as ((((powerlaw{1} + (sin{2} * 3)) + (sin{2}</span>
<span class="sd">        * 25)) - (powerlaw{1} * 16)) + (sin{2} ** 3.0))</span>
<span class="sd">    :return: the an instance of the requested class</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check whether this is a composite function or a simple function</span>
    <span class="k">if</span> <span class="n">composite_function_expression</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># Composite function</span>

        <span class="c1"># get the function</span>
        <span class="n">composite_function</span> <span class="o">=</span> <span class="n">_parse_function_expression</span><span class="p">(</span><span class="n">composite_function_expression</span><span class="p">)</span>

        <span class="c1"># it is possible that the functions have sub children</span>

        <span class="k">return</span> <span class="n">composite_function</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="n">_known_functions</span><span class="p">:</span>

            <span class="n">function_class</span> <span class="o">=</span> <span class="n">_known_functions</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span>

            <span class="n">deferred_properites</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">function_class</span><span class="o">.</span><span class="n">_properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">func_prop</span> <span class="ow">in</span> <span class="n">function_class</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                    <span class="c1"># we need to specify this in hte constructor</span>
                    <span class="c1"># this will change to the saved value when the</span>
                    <span class="c1"># function is fully built</span>

                    <span class="k">if</span> <span class="n">func_prop</span><span class="o">.</span><span class="n">is_deferred</span><span class="p">:</span>

                        <span class="k">if</span> <span class="n">func_prop</span><span class="o">.</span><span class="n">_allowed_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                            <span class="c1"># if there are only allowed values</span>
                            <span class="c1"># then we select the first one</span>

                            <span class="n">deferred_properites</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">func_prop</span><span class="o">.</span><span class="n">_allowed_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="k">else</span><span class="p">:</span>

                            <span class="n">deferred_properites</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;_tmp&quot;</span>

            <span class="c1"># Ok, let&#39;s create the instance</span>

            <span class="n">instance</span> <span class="o">=</span> <span class="n">function_class</span><span class="p">(</span><span class="o">**</span><span class="n">deferred_properites</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">instance</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Maybe this is a template</span>

            <span class="c1"># NOTE: import here to avoid circular import</span>

            <span class="kn">from</span><span class="w"> </span><span class="nn">astromodels.functions.template_model</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                <span class="n">InvalidTemplateModelFile</span><span class="p">,</span>
                <span class="n">MissingDataFile</span><span class="p">,</span>
                <span class="n">TemplateModel</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="n">instance</span> <span class="o">=</span> <span class="n">TemplateModel</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">MissingDataFile</span><span class="p">:</span>

                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Function </span><span class="si">%s</span><span class="s2"> is not known. Known functions are: </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_known_functions</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
                <span class="p">)</span>

                <span class="k">raise</span> <span class="n">UnknownFunction</span><span class="p">()</span>

            <span class="c1"># see if it is an emulator model from</span>
            <span class="c1"># netspec</span>

            <span class="k">except</span> <span class="n">InvalidTemplateModelFile</span><span class="p">:</span>

                <span class="k">try</span><span class="p">:</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;check if it is an emulator&quot;</span><span class="p">)</span>

                    <span class="kn">from</span><span class="w"> </span><span class="nn">netspec</span><span class="w"> </span><span class="kn">import</span> <span class="n">EmulatorModel</span>

                    <span class="n">instance</span> <span class="o">=</span> <span class="n">EmulatorModel</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Function </span><span class="si">%s</span><span class="s2"> is not known. Known functions are: </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="p">(</span>
                            <span class="n">function_name</span><span class="p">,</span>
                            <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_known_functions</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                    <span class="k">raise</span> <span class="n">UnknownFunction</span><span class="p">()</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="k">return</span> <span class="n">instance</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="k">return</span> <span class="n">instance</span></div>



<div class="viewcode-block" id="get_function_class">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.get_function_class">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_function_class</span><span class="p">(</span><span class="n">function_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the type for the requested function.</span>

<span class="sd">    :param function_name: the function to return</span>
<span class="sd">    :return: the type for that function (i.e., this is a class, not an</span>
<span class="sd">        instance)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="n">_known_functions</span><span class="p">:</span>

        <span class="k">return</span> <span class="n">_known_functions</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;Function </span><span class="si">%s</span><span class="s2"> is not known. Known functions are: </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_known_functions</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
        <span class="p">)</span>

        <span class="k">raise</span> <span class="n">UnknownFunction</span><span class="p">()</span></div>



<div class="viewcode-block" id="list_functions">
<a class="viewcode-back" href="../../../notebooks/api/astromodels.functions.html#astromodels.functions.list_functions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">list_functions</span><span class="p">():</span>

    <span class="c1"># Gather all defined functions and their descriptions</span>

    <span class="n">functions_and_descriptions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Description&quot;</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">_function_definition</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">_known_functions</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="p">}</span>

    <span class="c1"># Order by key (i.e., by function name)</span>

    <span class="n">ordered</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">functions_and_descriptions</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>

    <span class="c1"># Format in a table</span>

    <span class="n">table</span> <span class="o">=</span> <span class="n">dict_to_table</span><span class="p">(</span><span class="n">ordered</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">table</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_parse_function_expression</span><span class="p">(</span><span class="n">function_specification</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a complex function expression like:</span>

<span class="sd">    ((((powerlaw{1} + (sin{2} * 3)) + (sin{2} * 25)) -</span>
<span class="sd">    (powerlaw{1} * 16)) + (sin{2} ** 3.0))</span>

<span class="sd">    and return a composite function instance</span>

<span class="sd">    :param function_specification:</span>
<span class="sd">    :return: a composite function instance</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># NOTE FOR SECURITY</span>
    <span class="c1"># This function has some security concerns. Security issues could arise if the user</span>
    <span class="c1"># tries to read a model file which has been maliciously formatted to contain harmful</span>
    <span class="c1"># code. In this function we close all the doors to a similar attack, except for</span>
    <span class="c1"># those attacks which assume that the user has full access to a python environment.</span>
    <span class="c1"># Indeed, if that is the case, then the user can already do harm to the system, and</span>
    <span class="c1"># so there is no point in safeguard that from here. For example, the user could</span>
    <span class="c1"># format a subclass of the Function class which perform malicious operations in the</span>
    <span class="c1"># constructor, add that to the dictionary of known functions, and then interpret</span>
    <span class="c1"># it with this code. However, if the user can instance malicious classes, then why</span>
    <span class="c1"># would he use astromodels to carry out the attack? Instead, what we explicitly</span>
    <span class="c1"># check is the content of the function_specification string, so that it cannot by</span>
    <span class="c1"># itself do any harm (by for example containing instructions such as os.remove).</span>

    <span class="c1"># This can be a arbitrarily complex specification, like</span>
    <span class="c1"># ((((powerlaw{1} + (sin{2} * 3)) + (sin{2} * 25)) - (powerlaw{1} * 16))</span>
    <span class="c1"># + (sin{2} ** 3.0))</span>

    <span class="c1"># Use regular expressions to extract the set of functions like</span>
    <span class="c1"># function_name{number}, then build the set of unique functions by using the</span>
    <span class="c1"># constructor set()</span>

    <span class="n">unique_functions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b([a-zA-Z0-9_]+)\{([0-9]?[0-9]?[0-9]?)\}&quot;</span><span class="p">,</span> <span class="n">function_specification</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># NB: unique functions is a set like:</span>
    <span class="c1"># {(&#39;powerlaw&#39;, &#39;1&#39;), (&#39;sin&#39;, &#39;2&#39;)}</span>

    <span class="c1"># Create instances of the unique functions</span>

    <span class="n">instances</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Loop over the unique functions and create instances</span>

    <span class="k">for</span> <span class="n">unique_function</span><span class="p">,</span> <span class="n">number</span> <span class="ow">in</span> <span class="n">unique_functions</span><span class="p">:</span>

        <span class="n">complete_function_specification</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">{</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">unique_function</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>

        <span class="c1"># As first safety measure, check that the unique function is in the dictionary</span>
        <span class="c1"># of _known_functions. This could still be easily hacked, so it won&#39;t be the</span>
        <span class="c1"># only check</span>

        <span class="k">if</span> <span class="n">unique_function</span> <span class="ow">in</span> <span class="n">_known_functions</span><span class="p">:</span>

            <span class="c1"># Get the function class and check that it is indeed a proper Function class</span>

            <span class="n">function_class</span> <span class="o">=</span> <span class="n">_known_functions</span><span class="p">[</span><span class="n">unique_function</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">function_class</span><span class="p">,</span> <span class="n">Function</span><span class="p">):</span>

                <span class="c1"># let&#39;s see if there are any deferred</span>
                <span class="c1"># properties</span>

                <span class="n">deferred_properites</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">function_class</span><span class="o">.</span><span class="n">_properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">func_prop</span> <span class="ow">in</span> <span class="n">function_class</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                        <span class="c1"># we need to specify this in hte constructor</span>
                        <span class="c1"># this will change to the saved value when the</span>
                        <span class="c1"># function is fully built</span>

                        <span class="k">if</span> <span class="n">func_prop</span><span class="o">.</span><span class="n">is_deferred</span><span class="p">:</span>

                            <span class="k">if</span> <span class="n">func_prop</span><span class="o">.</span><span class="n">_allowed_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                                <span class="c1"># if there are only allowed values</span>
                                <span class="c1"># then we select the first one</span>

                                <span class="n">deferred_properites</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">func_prop</span><span class="o">.</span><span class="n">_allowed_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                            <span class="k">else</span><span class="p">:</span>

                                <span class="n">deferred_properites</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;_tmp&quot;</span>

                <span class="c1"># Ok, let&#39;s create the instance</span>

                <span class="n">instance</span> <span class="o">=</span> <span class="n">function_class</span><span class="p">(</span><span class="o">**</span><span class="n">deferred_properites</span><span class="p">)</span>

                <span class="c1"># Append the instance to the list</span>

                <span class="n">instances</span><span class="p">[</span><span class="n">complete_function_specification</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;The function specification </span><span class="si">%s</span><span class="s2"> does not contain a proper function&quot;</span>
                    <span class="o">%</span> <span class="n">unique_function</span>
                <span class="p">)</span>

                <span class="k">raise</span> <span class="n">FunctionDefinitionError</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># It might be a template</span>

            <span class="c1"># This import is here to avoid circular dependency between this module and</span>
            <span class="c1"># TemplateModel.py</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">astromodels.functions.template_model</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="n">instance</span> <span class="o">=</span> <span class="n">astromodels</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">template_model</span><span class="o">.</span><span class="n">TemplateModel</span><span class="p">(</span>
                    <span class="n">unique_function</span>
                <span class="p">)</span>

            <span class="k">except</span> <span class="n">astromodels</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">template_model</span><span class="o">.</span><span class="n">MissingDataFile</span><span class="p">:</span>

                <span class="c1"># It&#39;s not a template</span>

                <span class="k">raise</span> <span class="n">UnknownFunction</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Function </span><span class="si">{</span><span class="n">unique_function</span><span class="si">}</span><span class="s2"> in expression </span><span class="si">{</span><span class="n">function_specification</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="s2">&quot; is unknown. If this is a template model, you are &quot;</span>
                    <span class="s2">&quot;probably missing the data file&quot;</span>
                <span class="p">)</span>

            <span class="k">except</span> <span class="n">astromodels</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">template_model</span><span class="o">.</span><span class="n">InvalidTemplateModelFile</span><span class="p">:</span>

                <span class="c1"># It&#39;s not a template</span>

                <span class="k">try</span><span class="p">:</span>

                    <span class="kn">import</span><span class="w"> </span><span class="nn">netspec</span>

                    <span class="n">instance</span> <span class="o">=</span> <span class="n">netspec</span><span class="o">.</span><span class="n">EmulatorModel</span><span class="p">(</span><span class="n">unique_function</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>

                    <span class="k">raise</span> <span class="n">UnknownFunction</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Function </span><span class="si">{</span><span class="n">unique_function</span><span class="si">}</span><span class="s2"> in expression &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">function_specification</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="s2">&quot; is unknown. If this is a template model, you are &quot;</span>
                        <span class="s2">&quot;probably missing the data file&quot;</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="n">instances</span><span class="p">[</span><span class="n">complete_function_specification</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># It&#39;s a template</span>

                <span class="n">instances</span><span class="p">[</span><span class="n">complete_function_specification</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span>

    <span class="c1"># Check that we have found at least one instance.</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No known function in function specification&quot;</span><span class="p">)</span>

        <span class="k">raise</span> <span class="n">DesignViolation</span><span class="p">()</span>

    <span class="c1"># The following presents a slight security problem if the model file that has been</span>
    <span class="c1"># parsed comes from an untrusted source. Indeed, the use of eval could make possible</span>
    <span class="c1"># to execute things like os.remove. In order to avoid this, first we substitute the</span>
    <span class="c1"># function instances with numbers and remove the operators like +,-,/ and so on.</span>
    <span class="c1"># Then we try to execute the string with ast.literal_eval, which according to its</span>
    <span class="c1"># documentation:</span>

    <span class="c1"># Safely evaluate an expression node or a Unicode or Latin-1 encoded string</span>
    <span class="c1"># containing a Python literal or container display. The string or node provided may</span>
    <span class="c1"># only consist of the following Python literal structures: strings, numbers, tuples,</span>
    <span class="c1"># lists, dicts, booleans, and None.This can be used for safely evaluating strings</span>
    <span class="c1"># containing Python values from untrusted sources without the need to parse the</span>
    <span class="c1"># values oneself. It is not capable of evaluating arbitrarily complex expressions,</span>
    <span class="c1"># for example involving operators or indexing.</span>

    <span class="c1"># If literal_eval cannot parse the string, it means that it contains unsafe input.</span>

    <span class="c1"># Create a copy of the function_specification</span>

    <span class="n">string_for_literal_eval</span> <span class="o">=</span> <span class="n">function_specification</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="n">string_for_literal_eval</span><span class="p">)</span>

    <span class="c1"># Remove from the function_specification all the known operators and</span>
    <span class="c1"># function_expressions, and substitute them with a 0 and a space</span>

    <span class="c1"># Let&#39;s start from the function expression</span>

    <span class="k">for</span> <span class="n">function_expression</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">instances</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="n">function_expression</span><span class="p">)</span>

        <span class="n">string_for_literal_eval</span> <span class="o">=</span> <span class="n">string_for_literal_eval</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="n">function_expression</span><span class="p">,</span> <span class="s2">&quot;0 &quot;</span>
        <span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="n">string_for_literal_eval</span><span class="p">)</span>

    <span class="c1"># Now remove all the known operators</span>

    <span class="k">for</span> <span class="n">operator</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">_operations</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

        <span class="n">string_for_literal_eval</span> <span class="o">=</span> <span class="n">string_for_literal_eval</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">operator</span><span class="p">,</span> <span class="s2">&quot;0 &quot;</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug_node</span><span class="p">(</span><span class="n">string_for_literal_eval</span><span class="p">)</span>

    <span class="c1"># The string at this point should contains only numbers and parenthesis separated by</span>
    <span class="c1"># one or more spaces</span>

    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;([a-zA-Z]+)&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">string_for_literal_eval</span><span class="p">):</span>

        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Extraneous input in function specification&quot;</span><span class="p">)</span>

        <span class="k">raise</span> <span class="n">DesignViolation</span><span class="p">()</span>

    <span class="c1"># By using split() we separate all the numbers and parenthesis in a list, then we</span>
    <span class="c1"># join them with a comma, to end up with a comma-separated list of parenthesis and</span>
    <span class="c1"># numbers like: ((((0,0,(0,0,3)),0,(0,0,25)),0,(0,0,16)),0,(0,0,0,3.0))</span>
    <span class="c1"># This string can be parsed by literal_eval as a tuple containing other tuples,</span>
    <span class="c1"># which is fine. If the user has inserted some malicious content, like os.remove or</span>
    <span class="c1"># more weird stuff like code objects, the parsing will fail</span>

    <span class="n">string_for_literal_eval</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">string_for_literal_eval</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

    <span class="c1"># At this point the string should be just a comma separated list of numbers</span>

    <span class="c1"># Now try to execute the string</span>
    <span class="k">try</span><span class="p">:</span>

        <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">string_for_literal_eval</span><span class="p">)</span>

    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">SyntaxError</span><span class="p">):</span>

        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The given expression is not a valid function expression&quot;</span><span class="p">)</span>

        <span class="k">raise</span> <span class="n">DesignViolation</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="c1"># The expression is safe, let&#39;s eval it</span>

        <span class="c1"># First substitute the reference to the functions (like &#39;powerlaw{1}&#39;) with a</span>
        <span class="c1"># string corresponding to the instance dictionary</span>

        <span class="n">sanitized_function_specification</span> <span class="o">=</span> <span class="n">function_specification</span>

        <span class="k">for</span> <span class="n">function_expression</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">instances</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

            <span class="n">sanitized_function_specification</span> <span class="o">=</span> <span class="n">sanitized_function_specification</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="n">function_expression</span><span class="p">,</span> <span class="s1">&#39;instances[&quot;</span><span class="si">%s</span><span class="s1">&quot;]&#39;</span> <span class="o">%</span> <span class="n">function_expression</span>
            <span class="p">)</span>

        <span class="c1"># Now eval it. For safety measure, I remove all globals, and the only local is</span>
        <span class="c1"># the &#39;instances&#39; dictionary</span>

        <span class="n">composite_function</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span>
            <span class="n">sanitized_function_specification</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="s2">&quot;instances&quot;</span><span class="p">:</span> <span class="n">instances</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">composite_function</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016--2025, G.Vianello, J. M. Burgess, N. Di Lalla, N. Omodei, H. Fleischhack.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>